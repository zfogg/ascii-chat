description = """
Self-cleaning polecat work lifecycle. You receive an issue, implement it, pass quality gates, submit via `gt done`, and disappear.

**The contract:** You're a capable worker. Your CLAUDE.md is already injected by `gt prime`. Trust it. Do the work. Commit as you go. If you get stuck for 15 minutes or face something unclear, mail Witness. If you can't proceed, don't guess—ask.

**What you don't do:** Push directly. Close your own issue. Wait for merge. Handle rebase conflicts. The Refinery does those things.

**What `gt done` does:** Push your branch, file an MR in the queue, nuke your sandbox, exit. Done means gone."""
formula = "mol-polecat-work"
version = 6

[[steps]]
id = "load-context"
title = "Load context and verify assignment"
description = """
Understand your assignment and what "done" means.

**1. Prime:**
```bash
gt prime
bd prime
```

**2. Read your issue:**
```bash
bd show {{issue}}
```

Understand: What exactly is being asked? What files are involved? Any blockers?

**3. Check mail once:**
```bash
gt mail inbox
```

Read any HANDOFF context. Skip the rest.

**4. Verify you can proceed:**
- No unresolved blockers on {{issue}}
- Requirements are clear
- You understand what done looks like

**If unclear or blocked:** Mail Witness immediately. Don't guess.
```bash
gt mail send <rig>/witness -s "HELP: {{issue}}" -m "Question: <what you need>"
```

**Exit:** You understand the work. Proceed to branch-setup."""

[[steps]]
id = "branch-setup"
title = "Set up working branch"
needs = ["load-context"]
description = """
Get on a clean feature branch, rebased on {{base_branch}}.

**1. Create or switch to your branch:**
```bash
git fetch origin
git checkout -b polecat/<name> origin/{{base_branch}}
```

**2. Ensure clean working tree:**
If dirty from previous work, commit or stash it. Then:
```bash
git rebase origin/{{base_branch}}
```

If rebase has conflicts, resolve them. If stuck, mail Witness.

**3. If setup_command is configured, run it:**
```bash
{{setup_command}}
```

Empty means not needed—skip.

**Exit:** Clean branch, rebased, dependencies installed. Ready to implement."""

[[steps]]
id = "implement"
title = "Implement the solution"
needs = ["branch-setup"]
description = """
Do the work. Commit as you go. Review your own changes. File discovered bugs as new beads.

**Working principles:**
- Follow existing codebase style
- Make atomic, focused commits
- Reference {{issue}} in commit messages
- Keep changes scoped to the assignment

**As you work:**
1. Make commits frequently
2. Review your diff sometimes: `git diff` looks good?
3. If you find unrelated bugs, file them as beads—don't fix them:
   ```bash
   bd create --title "Found: <description>" --type bug --priority 2
   ```

**If stuck:** Don't spin. After 15 minutes, mail Witness:
```bash
gt mail send <rig>/witness -s "HELP: {{issue}}" -m "Stuck on: <what>
Tried: <what you attempted>"
```

**Exit:** Implementation complete. All changes committed. Working tree clean.
```bash
git status  # Should show "nothing to commit, working tree clean"
```"""

[[steps]]
id = "quality-gates"
title = "Run quality checks (if code changed)"
needs = ["implement"]
description = """
Only run checks if you changed code. If this was docs/config-only, skip to submit.

**Check: Did you change code?**
```bash
git diff origin/{{base_branch}} -- '*.go' '*.ts' '*.tsx' '*.js' '*.jsx' '*.py' ...
# (list relevant extensions for your project)
```

If NO code changed (docs, config, comments only): Jump to submit-and-exit. You're done.

If YES code changed, continue below.

**1. Run configured quality checks:**
- If setup_command: `{{setup_command}}`
- If typecheck_command: `{{typecheck_command}}`
- If lint_command: `{{lint_command}}`
- If build_command: `{{build_command}}`

**ALL must pass.**

If a check fails:
- Is it your change? Fix it, commit, loop back.
- Is it pre-existing on {{base_branch}}? File a bead. Note it in your PR. Your PR must still pass.

**2. Run ONLY tests related to your changes.**

**CRITICAL:** Do NOT run the full test suite (`go test ./...`, `npm test`, etc.). This is a shared machine. Full test runs hammer CPU/RAM for everyone.

Run only tests that cover the packages/modules you touched:
```bash
# Example (Go): If you touched api/, run:
go test ./api/...

# Example (Node): If you touched src/hooks/, run:
npm test -- src/hooks
```

If you don't know which tests are relevant, run none and note it in your PR notes: "No focused tests run—ask Witness for full test arrangement."

**If tests fail:**
- Your change caused it? Fix it, commit, re-run.
- Pre-existing? File a bead. Note it. Your PR must still be green.

**Exit:** Code quality checks pass. Relevant tests pass. Working tree clean."""

[[steps]]
id = "submit-and-exit"
title = "Submit and self-clean"
needs = ["quality-gates"]
description = """
Update notes, sync beads, push via `gt done`. You cease to exist after this.

**1. Update issue notes:**
```bash
bd update {{issue}} --notes "Implemented: <brief summary>"
```

**2. Sync beads:**
```bash
bd sync --flush-only
```

**3. Submit and exit:**
```bash
gt done
```

This pushes your branch, files an MR in the merge queue, nukes your sandbox, exits.

You should see output like:
```
✓ Work submitted to merge queue
  MR ID: gt-xxxxx
  Source: polecat/<name>
  Target: {{base_branch}}
✓ Sandbox nuked
✓ Session exiting
```

**After you're gone:** Refinery processes the MR, rebases, merges, closes the issue. If conflicts arise, Refinery spawns a fresh polecat. You're not involved. Done means gone."""

[vars]
[vars.issue]
description = "The issue ID assigned to this polecat"
required = true

[vars.base_branch]
description = "The base branch to rebase on and compare against (e.g., main, integration/epic-id)"
default = "main"

[vars.setup_command]
description = "Setup/install command (e.g., pnpm install). Empty = skip."
default = ""

[vars.typecheck_command]
description = "Type check command (e.g., tsc --noEmit). Empty = skip."
default = ""

[vars.test_command]
description = "Command to run tests (auto-detected from rig settings)"
default = ""

[vars.lint_command]
description = "Command to run linting. Empty = skip."
default = ""

[vars.build_command]
description = "Command to run build. Empty = skip."
default = ""
