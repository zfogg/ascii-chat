name: Test Suite

on:
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'tests/**'
      - 'bazel/**'
      - 'BUILD.bazel'
      - 'MODULE.bazel'
      - 'WORKSPACE'
      - '.bazelrc'
      - '.github/workflows/test.yml'
  pull_request:
    branches: ['*']
    paths:
      - 'src/**'
      - 'lib/**'
      - 'tests/**'
      - 'bazel/**'
      - 'BUILD.bazel'
      - 'MODULE.bazel'
      - 'WORKSPACE'
      - '.bazelrc'
      - '.github/workflows/test.yml'

permissions:
  contents: read
  issues: read
  checks: write
  pull-requests: write

jobs:
  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
          - os: macOS
            runner: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          fetch-tags: true
          submodules: true

      # Install dependencies (including cached Bazelisk)
      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          os: ${{ matrix.os == 'Linux' && 'ubuntu' || 'macos' }}
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}

      # Install additional system dependencies
      - name: Install dependencies (Linux)
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libzstd-dev libsodium-dev portaudio19-dev libcriterion-dev \
            clang llvm lld llvm-dev libclang-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macOS'
        run: |
          brew install llvm zstd libsodium portaudio criterion

      # Cache Bazel
      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-test-${{ matrix.os }}-${{ hashFiles('MODULE.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-test-${{ matrix.os }}-

      # Run tests with BuildBuddy
      - name: Run unit tests
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}
          CC: clang
          CXX: clang++
        run: |
          BAZEL_ARGS="--config=ci --define=skip_defer=true"
          if [ -n "$BUILDBUDDY_API_KEY" ]; then
            BAZEL_ARGS="$BAZEL_ARGS --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY"
          fi
          echo "Running Bazel tests..."
          bazel test //tests:all $BAZEL_ARGS --test_output=errors --test_tag_filters=unit 2>&1 | tee test-output.log || true

          echo ""
          echo "=== Test Summary ==="
          bazel test //tests:all $BAZEL_ARGS --test_output=summary --test_tag_filters=unit 2>&1 || true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            test-output.log
            bazel-testlogs/**/*.log
          retention-days: 7

  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
          - os: macOS
            runner: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          fetch-tags: true
          submodules: true

      # Install dependencies (including cached Bazelisk)
      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          os: ${{ matrix.os == 'Linux' && 'ubuntu' || 'macos' }}
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Install dependencies (Linux)
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config libzstd-dev libsodium-dev portaudio19-dev libcriterion-dev \
            clang llvm lld llvm-dev libclang-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macOS'
        run: brew install llvm zstd libsodium portaudio criterion

      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-integration-${{ matrix.os }}-${{ hashFiles('MODULE.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-integration-${{ matrix.os }}-

      - name: Run integration tests
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}
          CC: clang
          CXX: clang++
        run: |
          BAZEL_ARGS="--config=ci --define=skip_defer=true"
          if [ -n "$BUILDBUDDY_API_KEY" ]; then
            BAZEL_ARGS="$BAZEL_ARGS --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY"
          fi
          echo "Running integration tests..."
          bazel test //tests:all $BAZEL_ARGS --test_output=errors --test_tag_filters=integration 2>&1 | tee test-output.log || true

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-${{ matrix.os }}
          path: |
            test-output.log
            bazel-testlogs/**/*.log
          retention-days: 7

  functional-tests:
    name: Functional Tests (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
          - os: macOS
            runner: macos-15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          fetch-tags: true
          submodules: true

      # Install dependencies (including cached Bazelisk)
      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          os: ${{ matrix.os == 'Linux' && 'ubuntu' || 'macos' }}
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Install dependencies (Linux)
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config libzstd-dev libsodium-dev portaudio19-dev \
            clang llvm lld llvm-dev libclang-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macOS'
        run: brew install llvm zstd libsodium portaudio

      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-functional-${{ matrix.os }}-${{ hashFiles('MODULE.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-functional-${{ matrix.os }}-

      - name: Build binary
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}
          CC: clang
          CXX: clang++
        run: |
          BAZEL_ARGS="--config=ci --define=skip_defer=true"
          if [ -n "$BUILDBUDDY_API_KEY" ]; then
            BAZEL_ARGS="$BAZEL_ARGS --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY"
          fi
          bazel build //src:ascii-chat $BAZEL_ARGS

      - name: Test binary help and modes
        env:
          TERM: xterm-256color
        run: |
          ./bazel-bin/src/ascii-chat --help
          ./bazel-bin/src/ascii-chat server --help
          ./bazel-bin/src/ascii-chat client --help
          # Test basic server startup (short timeout)
          timeout 2s ./bazel-bin/src/ascii-chat server --log-file /tmp/server_test.log || true
          echo "Binary help and mode tests passed"

      - name: Test client capabilities
        env:
          TERM: xterm-256color
        run: |
          ./bazel-bin/src/ascii-chat client --show-capabilities
          echo "✅ Client capability detection test passed"

  memory-tests:
    name: Memory Tests (Valgrind)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          fetch-tags: true
          submodules: true

      # Install dependencies (including cached Bazelisk)
      - name: Install dependencies
        uses: ./.github/actions/install-deps
        with:
          os: ubuntu
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}

      - name: Install dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config libzstd-dev libsodium-dev portaudio19-dev \
            clang llvm lld valgrind

      - name: Cache Bazel
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-memory-linux-${{ hashFiles('MODULE.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-memory-linux-

      - name: Build debug binary
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}
          CC: clang
          CXX: clang++
        run: |
          BAZEL_ARGS="--define=skip_defer=true"
          if [ -n "$BUILDBUDDY_API_KEY" ]; then
            BAZEL_ARGS="$BAZEL_ARGS --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY"
          fi
          bazel build //src:ascii-chat -c dbg $BAZEL_ARGS

      - name: Run memory leak detection
        run: |
          echo "Testing binary memory usage..."
          timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            ./bazel-bin/src/ascii-chat server > valgrind-server.log 2>&1 &
          SERVER_PID=$!
          timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            ./bazel-bin/src/ascii-chat client --test-pattern > valgrind-client.log 2>&1 &
          CLIENT_PID=$!
          wait $SERVER_PID || true
          wait $CLIENT_PID || true

      - name: Analyze memory reports
        run: |
          echo "=== Binary Memory Analysis ==="
          if grep -q "definitely lost" valgrind-*.log; then
            echo "❌ Memory leaks detected"
            grep "definitely lost" valgrind-*.log
          else
            echo "✅ No memory leaks detected"
          fi

      - name: Upload memory test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-test-results
          path: valgrind-*.log
          retention-days: 7
