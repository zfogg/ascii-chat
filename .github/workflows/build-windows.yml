name: Build Windows

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  CC: clang
  CXX: clang++

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Install dependencies
        id: install-deps
        uses: ./.github/actions/install-deps
        with:
          os: windows
          vcpkg-packages: "zstd portaudio libsodium"
          vcpkg-static-packages: "zstd portaudio libsodium mimalloc"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure
        shell: pwsh
        run: |
          $deferTool = "${{ steps.install-deps.outputs.defer-tool-path }}"
          # Disable analyzers - GitHub Actions Windows runner has broken cppcheck from Strawberry Perl
          # Disable tests - Criterion doesn't work well on Windows
          cmake --preset release -DASCIICHAT_DEFER_TOOL="$deferTool" -DASCIICHAT_ENABLE_ANALYZERS=OFF -DASCIICHAT_ENABLE_TESTS=OFF

      - name: Build
        shell: pwsh
        run: |
          cmake --build build_release --target ascii-chat
          cmake --build build_release --target static-lib
          cmake --build build_release --target shared-lib

      - name: Verify build artifacts
        shell: pwsh
        run: |
          Write-Host "=== Verifying build artifacts ==="
          $binDir = "build_release/bin"
          if (!(Test-Path "$binDir/ascii-chat.exe")) {
            Write-Host "ERROR: ascii-chat.exe not found!"
            exit 1
          }
          Write-Host "Build successful! Found ascii-chat.exe"
          Get-ChildItem -Path $binDir

