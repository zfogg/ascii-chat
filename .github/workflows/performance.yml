name: Performance Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.c'
      - '**.h'
      - '**.m'
  pull_request:
    branches: [ '*' ]
    paths:
      - '**.c'
      - '**.h'
      - '**.m'
  schedule:
    # Run performance tests weekly
    - cron: '0 4 * * 1'

env:
  CC: clang
  CXX: clang++

jobs:
  memory-profiling:
    name: Memory Usage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
        submodules: true

    - name: Install dependencies with caching
      uses: ./.github/actions/install-deps
      with:
        os: ubuntu
        extra-packages: valgrind

    - name: Cache build, dependencies, and ccache
      id: cache-build
      uses: ./.github/actions/cache-build
      with:
        cache-version: v5

    - name: Clean build directory to force reconfigure
      run: |
        rm -rf build/CMakeCache.txt build/CMakeFiles
        # Clean library files to prevent stale archive format issues when switching build types
        rm -rf build/lib/*.a

    - name: Build with debug symbols
      run: |
        cmake --preset github -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=OFF
        cmake --build build

    - name: Save build caches
      if: always()
      uses: ./.github/actions/cache-build-save
      with:
        build-directory: ${{ steps.cache-build.outputs['build-directory-path'] }}
        build-cache-key: ${{ steps.cache-build.outputs['build-cache-key'] }}
        build-cache-hit: ${{ steps.cache-build.outputs['build-cache-hit'] }}
        cache-deps-enabled: ${{ steps.cache-build.outputs['cache-deps-enabled'] }}
        deps-cache-directory: ${{ steps.cache-build.outputs['deps-cache-path'] }}
        deps-cache-key: ${{ steps.cache-build.outputs['deps-cache-key'] }}
        deps-cache-hit: ${{ steps.cache-build.outputs['deps-cache-hit'] }}
        cache-ccache-enabled: ${{ steps.cache-build.outputs['cache-ccache-enabled'] }}
        ccache-directory: ${{ steps.cache-build.outputs['ccache-directory-path'] }}
        ccache-cache-key: ${{ steps.cache-build.outputs['ccache-cache-key'] }}
        ccache-cache-hit: ${{ steps.cache-build.outputs['ccache-cache-hit'] }}

    - name: Upload memory reports
      uses: actions/upload-artifact@v4
      with:
        name: memory-analysis-reports
        path: valgrind-*.log
        retention-days: 30

  build-optimization:
    name: Build Size and Performance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
        submodules: true

    - name: Install dependencies with caching
      uses: ./.github/actions/install-deps
      with:
        os: ubuntu

    - name: Cache debug build, dependencies, and ccache
      id: cache-build-debug
      uses: ./.github/actions/cache-build
      with:
        build-directory: ${{ github.workspace }}/build_debug
        build-cache-key: performance-debug
        cache-version: v5
    - name: Cache release build directory
      id: cache-build-release
      uses: ./.github/actions/cache-build
      with:
        build-directory: ${{ github.workspace }}/build_release
        build-cache-key: performance-release
        cache-version: v5

    - name: Clean build directories to force reconfigure
      run: |
        rm -rf build_debug/CMakeCache.txt build_debug/CMakeFiles
        rm -rf build_release/CMakeCache.txt build_release/CMakeFiles

    - name: Build different optimization levels
      run: |
        echo "Building debug version..."
        cmake --preset github -B build_debug \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=OFF
        cmake --build build_debug
        DEBUG_SIZE=$(stat -f%z build_debug/bin/ascii-chat 2>/dev/null || stat -c%s build_debug/bin/ascii-chat)

        echo "Building release version..."
        cmake --preset github -B build_release \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_MIMALLOC=ON \
          -DASCIICHAT_ENFORCE_STATIC_RELEASE=OFF \
          -DASCIICHAT_ENABLE_COVERAGE=OFF \
          -DBUILD_TESTS=OFF
        cmake --build build_release
        RELEASE_SIZE=$(stat -f%z build_release/bin/ascii-chat 2>/dev/null || stat -c%s build_release/bin/ascii-chat)

        echo "=== Binary Size Comparison ==="
        echo "Binary - Debug: $(($DEBUG_SIZE / 1024))KB, Release: $(($RELEASE_SIZE / 1024))KB"

        # Calculate optimization savings
        SAVINGS=$((($DEBUG_SIZE - $RELEASE_SIZE) * 100 / $DEBUG_SIZE))

        echo "Space savings: ${SAVINGS}%"

    - name: Test startup performance
      run: |
        echo "Testing binary startup time..."

        # Test help command performance (safe to run without dependencies)
        echo "Help command startup time:"
        time ./build_release/bin/ascii-chat --help

    - name: Save debug build caches
      if: always()
      uses: ./.github/actions/cache-build-save
      with:
        build-directory: ${{ steps.cache-build-debug.outputs['build-directory-path'] }}
        build-cache-key: ${{ steps.cache-build-debug.outputs['build-cache-key'] }}
        build-cache-hit: ${{ steps.cache-build-debug.outputs['build-cache-hit'] }}
        cache-deps-enabled: ${{ steps.cache-build-debug.outputs['cache-deps-enabled'] }}
        deps-cache-directory: ${{ steps.cache-build-debug.outputs['deps-cache-path'] }}
        deps-cache-key: ${{ steps.cache-build-debug.outputs['deps-cache-key'] }}
        deps-cache-hit: ${{ steps.cache-build-debug.outputs['deps-cache-hit'] }}
        cache-ccache-enabled: ${{ steps.cache-build-debug.outputs['cache-ccache-enabled'] }}
        ccache-directory: ${{ steps.cache-build-debug.outputs['ccache-directory-path'] }}
        ccache-cache-key: ${{ steps.cache-build-debug.outputs['ccache-cache-key'] }}
        ccache-cache-hit: ${{ steps.cache-build-debug.outputs['ccache-cache-hit'] }}

    - name: Save release build caches
      if: always()
      uses: ./.github/actions/cache-build-save
      with:
        build-directory: ${{ steps.cache-build-release.outputs['build-directory-path'] }}
        build-cache-key: ${{ steps.cache-build-release.outputs['build-cache-key'] }}
        build-cache-hit: ${{ steps.cache-build-release.outputs['build-cache-hit'] }}
        cache-deps-enabled: ${{ steps.cache-build-release.outputs['cache-deps-enabled'] }}
        deps-cache-directory: ${{ steps.cache-build-release.outputs['deps-cache-path'] }}
        deps-cache-key: ${{ steps.cache-build-release.outputs['deps-cache-key'] }}
        deps-cache-hit: ${{ steps.cache-build-release.outputs['deps-cache-hit'] }}
        cache-ccache-enabled: ${{ steps.cache-build-release.outputs['cache-ccache-enabled'] }}
        ccache-directory: ${{ steps.cache-build-release.outputs['ccache-directory-path'] }}
        ccache-cache-key: ${{ steps.cache-build-release.outputs['ccache-cache-key'] }}
        ccache-cache-hit: ${{ steps.cache-build-release.outputs['ccache-cache-hit'] }}

  code-metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
        submodules: true

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y make cloc sloccount

    - name: Generate code metrics
      run: |
        echo "=== Lines of Code Analysis ==="
        make cloc

        echo "=== Detailed File Analysis ==="
        wc -l *.c *.h *.m 2>/dev/null | sort -n || true

        echo "=== Function Count ==="
        echo "C functions:"
        grep -c "^[a-zA-Z_][a-zA-Z0-9_]*.*(" *.c 2>/dev/null | head -10 || true

        echo "Header declarations:"
        grep -c "^[a-zA-Z_][a-zA-Z0-9_]*.*(" *.h 2>/dev/null | head -10 || true

    - name: Check code complexity
      run: |
        echo "=== Cyclomatic Complexity Check ==="
        # Simple complexity check - count nested braces
        for file in *.c; do
          if [[ -f "$file" ]]; then
            complexity=$(grep -o '{' "$file" | wc -l)
            echo "$file: $complexity blocks"
          fi
        done
