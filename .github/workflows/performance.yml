name: Performance Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.c'
      - '**.h'
      - '**.m'
  pull_request:
    branches: [ '*' ]
    paths:
      - '**.c'
      - '**.h'
      - '**.m'
  schedule:
    # Run performance tests weekly
    - cron: '0 4 * * 1'

env:
  CC: clang
  CXX: clang++

jobs:
  memory-profiling:
    name: Memory Usage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: Install dependencies with caching
      uses: ./.github/actions/install-deps
      with:
        os: ubuntu
        extra-packages: valgrind

    - name: Cache build, dependencies, and ccache
      uses: ./.github/actions/cache-build

    - name: Build with debug symbols
      run: |
        GITHUB_CMAKE_BINARY_DIR=build cmake --preset github \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=OFF
        cmake --build build

    - name: Run memory leak detection
      run: |
        echo "Testing binary memory usage..."
        # NOTE: THese are started with "&" and run in the background with no logs.
        timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
          ./build/bin/ascii-chat server > valgrind-server.log 2>&1 &
        SERVER_PID=$!
        # Run server in the background so the command doesn't block until the process is dead so we can start the client.
        timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
          ./build/bin/ascii-chat client --test-pattern > valgrind-client.log 2>&1 &
        CLIENT_PID=$!
        wait $SERVER_PID $CLIENT_PID

    - name: Analyze memory reports
      run: |
        echo "=== Binary Memory Analysis ==="
        if grep -q "definitely lost" valgrind-*.log; then
          echo "❌ Memory leaks detected"
          grep "definitely lost" valgrind-*.log
        else
          echo "✅ No memory leaks detected"
        fi

    - name: Upload memory reports
      uses: actions/upload-artifact@v4
      with:
        name: memory-analysis-reports
        path: valgrind-*.log
        retention-days: 30

  build-optimization:
    name: Build Size and Performance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: Install dependencies with caching
      uses: ./.github/actions/install-deps
      with:
        os: ubuntu

    - name: Cache debug build, dependencies, and ccache
      uses: ./.github/actions/cache-build
      with:
        build-directory: ${{ github.workspace }}/build_debug
        build-cache-key: performance-debug
    - name: Cache release build directory
      uses: ./.github/actions/cache-build
      with:
        build-directory: ${{ github.workspace }}/build_release
        build-cache-key: performance-release

    - name: Build different optimization levels
      run: |
        echo "Building debug version..."
        GITHUB_CMAKE_BINARY_DIR=build_debug cmake --preset github \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=OFF
        cmake --build build_debug
        DEBUG_SIZE=$(stat -f%z build_debug/bin/ascii-chat 2>/dev/null || stat -c%s build_debug/bin/ascii-chat)

        echo "Building release version..."
        GITHUB_CMAKE_BINARY_DIR=build_release cmake --preset github \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_MIMALLOC=ON \
          -DASCIICHAT_ENFORCE_STATIC_RELEASE=OFF \
          -DBUILD_TESTS=OFF
        cmake --build build_release
        RELEASE_SIZE=$(stat -f%z build_release/bin/ascii-chat 2>/dev/null || stat -c%s build_release/bin/ascii-chat)

        echo "=== Binary Size Comparison ==="
        echo "Binary - Debug: $(($DEBUG_SIZE / 1024))KB, Release: $(($RELEASE_SIZE / 1024))KB"

        # Calculate optimization savings
        SAVINGS=$((($DEBUG_SIZE - $RELEASE_SIZE) * 100 / $DEBUG_SIZE))

        echo "Space savings: ${SAVINGS}%"

    - name: Test startup performance
      run: |
        echo "Testing binary startup time..."

        # Test help command performance (safe to run without dependencies)
        echo "Help command startup time:"
        time ./build_release/bin/ascii-chat --help

  code-metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y make cloc sloccount

    - name: Generate code metrics
      run: |
        echo "=== Lines of Code Analysis ==="
        make cloc

        echo "=== Detailed File Analysis ==="
        wc -l *.c *.h *.m 2>/dev/null | sort -n || true

        echo "=== Function Count ==="
        echo "C functions:"
        grep -c "^[a-zA-Z_][a-zA-Z0-9_]*.*(" *.c 2>/dev/null | head -10 || true

        echo "Header declarations:"
        grep -c "^[a-zA-Z_][a-zA-Z0-9_]*.*(" *.h 2>/dev/null | head -10 || true

    - name: Check code complexity
      run: |
        echo "=== Cyclomatic Complexity Check ==="
        # Simple complexity check - count nested braces
        for file in *.c; do
          if [[ -f "$file" ]]; then
            complexity=$(grep -o '{' "$file" | wc -l)
            echo "$file: $complexity blocks"
          fi
        done
