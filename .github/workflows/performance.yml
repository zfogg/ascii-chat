name: Performance Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.c'
      - '**.h'
      - '**.m'
  pull_request:
    branches: [ '*' ]
    paths:
      - '**.c'
      - '**.h'
      - '**.m'
  schedule:
    # Run performance tests weekly
    - cron: '0 4 * * 1'

jobs:
  memory-profiling:
    name: Memory Usage Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies with caching
      uses: ./.github/actions/install-deps
      with:
        os: ubuntu
        extra-packages: valgrind

    - name: Build with debug symbols
      run: |
        CC=clang CXX=clang++ cmake -B build -G Ninja \
          -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_STANDARD=23 \
          -DCMAKE_C_FLAGS='-std=c2x' -DBUILD_TESTS=ON
        cmake --build build

    - name: Run memory leak detection
      run: |
        echo "Testing server memory usage..."
        timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
          ./build/bin/ascii-chat-server --help > valgrind_server.log 2>&1 || true

        echo "Testing client memory usage..."
        timeout 10s valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
          ./build/bin/ascii-chat-client --help > valgrind_client.log 2>&1 || true

    - name: Analyze memory reports
      run: |
        echo "=== Server Memory Analysis ==="
        if grep -q "definitely lost" valgrind_server.log; then
          echo "❌ Memory leaks detected in server"
          grep "definitely lost" valgrind_server.log
        else
          echo "✅ No memory leaks detected in server"
        fi

        echo "=== Client Memory Analysis ==="
        if grep -q "definitely lost" valgrind_client.log; then
          echo "❌ Memory leaks detected in client"
          grep "definitely lost" valgrind_client.log
        else
          echo "✅ No memory leaks detected in client"
        fi

    - name: Upload memory reports
      uses: actions/upload-artifact@v4
      with:
        name: memory-analysis-reports
        path: |
          valgrind_server.log
          valgrind_client.log
        retention-days: 30

  build-optimization:
    name: Build Size and Performance
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies with caching
      uses: ./.github/actions/install-deps
      with:
        os: ubuntu

    - name: Build different optimization levels
      run: |
        echo "Building debug version..."
        CC=clang CXX=clang++ cmake -B build_debug -G Ninja \
          -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_STANDARD=23 \
          -DCMAKE_C_FLAGS='-std=c2x'
        cmake --build build_debug
        DEBUG_SERVER_SIZE=$(stat -f%z build_debug/bin/ascii-chat-server 2>/dev/null || stat -c%s build_debug/bin/ascii-chat-server)
        DEBUG_CLIENT_SIZE=$(stat -f%z build_debug/bin/ascii-chat-client 2>/dev/null || stat -c%s build_debug/bin/ascii-chat-client)

        echo "Building release version..."
        CC=clang CXX=clang++ cmake -B build_release -G Ninja \
          -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_STANDARD=23 \
          -DCMAKE_C_FLAGS='-std=c2x'
        cmake --build build_release
        RELEASE_SERVER_SIZE=$(stat -f%z build_release/bin/ascii-chat-server 2>/dev/null || stat -c%s build_release/bin/ascii-chat-server)
        RELEASE_CLIENT_SIZE=$(stat -f%z build_release/bin/ascii-chat-client 2>/dev/null || stat -c%s build_release/bin/ascii-chat-client)

        echo "=== Binary Size Comparison ==="
        echo "Server - Debug: $(($DEBUG_SERVER_SIZE / 1024))KB, Release: $(($RELEASE_SERVER_SIZE / 1024))KB"
        echo "Client - Debug: $(($DEBUG_CLIENT_SIZE / 1024))KB, Release: $(($RELEASE_CLIENT_SIZE / 1024))KB"

        # Calculate optimization savings
        SERVER_SAVINGS=$((($DEBUG_SERVER_SIZE - $RELEASE_SERVER_SIZE) * 100 / $DEBUG_SERVER_SIZE))
        CLIENT_SAVINGS=$((($DEBUG_CLIENT_SIZE - $RELEASE_CLIENT_SIZE) * 100 / $DEBUG_CLIENT_SIZE))

        echo "Space savings - Server: ${SERVER_SAVINGS}%, Client: ${CLIENT_SAVINGS}%"

    - name: Test startup performance
      run: |
        echo "Testing binary startup time..."

        # Test help command performance (safe to run without dependencies)
        echo "Server help startup time:"
        time ./build_release/bin/ascii-chat-server --help

        echo "Client help startup time:"
        time ./build_release/bin/ascii-chat-client --help

  code-metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cloc sloccount

    - name: Generate code metrics
      run: |
        echo "=== Lines of Code Analysis ==="
        cloc --exclude-dir=ext,build,bin,.github,.claude,.cursor .

        echo "=== Detailed File Analysis ==="
        wc -l *.c *.h *.m 2>/dev/null | sort -n || true

        echo "=== Function Count ==="
        echo "C functions:"
        grep -c "^[a-zA-Z_][a-zA-Z0-9_]*.*(" *.c 2>/dev/null | head -10 || true

        echo "Header declarations:"
        grep -c "^[a-zA-Z_][a-zA-Z0-9_]*.*(" *.h 2>/dev/null | head -10 || true

    - name: Check code complexity
      run: |
        echo "=== Cyclomatic Complexity Check ==="
        # Simple complexity check - count nested braces
        for file in *.c; do
          if [[ -f "$file" ]]; then
            complexity=$(grep -o '{' "$file" | wc -l)
            echo "$file: $complexity blocks"
          fi
        done
