name: Build

on:
  push:
    branches: [master, main]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'bazel/**'
      - 'BUILD.bazel'
      - 'MODULE.bazel'
      - 'WORKSPACE'
      - '.bazelrc'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'bazel/**'
      - 'BUILD.bazel'
      - 'MODULE.bazel'
      - 'WORKSPACE'
      - '.bazelrc'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: Linux
            arch: amd64
            runner: ubuntu-latest
            bazel-config: ""

          # Linux ARM64
          - os: Linux
            arch: arm64
            runner: ubuntu-24.04-arm
            bazel-config: ""

          # macOS AMD64 (Intel)
          - os: macOS
            arch: amd64
            runner: macos-15-intel
            bazel-config: ""

          # macOS ARM64 (Apple Silicon)
          - os: macOS
            arch: arm64
            runner: macos-15
            bazel-config: ""

          # Windows AMD64
          - os: Windows
            arch: amd64
            runner: windows-latest
            bazel-config: "--config=windows"

          # Windows ARM64
          - os: Windows
            arch: arm64
            runner: windows-11-arm
            bazel-config: "--config=windows"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      # Install Bazelisk
      - name: Install Bazelisk (Linux)
        if: matrix.os == 'Linux'
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            BAZELISK_ARCH="amd64"
          elif [ "$ARCH" = "aarch64" ]; then
            BAZELISK_ARCH="arm64"
          fi
          sudo curl -fsSL -o /usr/local/bin/bazel \
            "https://github.com/bazelbuild/bazelisk/releases/download/v1.25.0/bazelisk-linux-${BAZELISK_ARCH}"
          sudo chmod +x /usr/local/bin/bazel

      - name: Install Bazelisk (macOS)
        if: matrix.os == 'macOS'
        run: brew install bazelisk

      - name: Install Bazelisk (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # Download bazelisk directly
          $arch = if ($env:PROCESSOR_ARCHITECTURE -eq "ARM64") { "arm64" } else { "amd64" }
          $url = "https://github.com/bazelbuild/bazelisk/releases/download/v1.25.0/bazelisk-windows-${arch}.exe"
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\bin" | Out-Null
          Invoke-WebRequest -Uri $url -OutFile "$env:USERPROFILE\bin\bazel.exe"
          echo "$env:USERPROFILE\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # Install system dependencies for building
      - name: Install dependencies (Linux)
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libzstd-dev libsodium-dev portaudio19-dev \
            clang llvm lld

      - name: Install dependencies (macOS)
        if: matrix.os == 'macOS'
        run: |
          brew install llvm zstd libsodium portaudio

      - name: Install dependencies (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # vcpkg is pre-installed on GitHub runners
          vcpkg install zstd:x64-windows libsodium:x64-windows portaudio:x64-windows

      # Cache Bazel
      - name: Cache Bazel repository
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/bazel
            ~/.cache/bazelisk
          key: bazel-${{ matrix.os }}-${{ matrix.arch }}-${{ hashFiles('MODULE.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-${{ matrix.os }}-${{ matrix.arch }}-

      - name: Cache Bazel repository (Windows)
        if: matrix.os == 'Windows'
        uses: actions/cache@v4
        with:
          path: |
            ~/_bazel_*
            ~/AppData/Local/bazelisk
          key: bazel-windows-${{ matrix.arch }}-${{ hashFiles('MODULE.bazel', 'WORKSPACE', '.bazelrc') }}
          restore-keys: |
            bazel-windows-${{ matrix.arch }}-

      # Build
      - name: Build (Unix)
        if: matrix.os != 'Windows'
        run: |
          bazel build //src:ascii-chat //lib:all ${{ matrix.bazel-config }}

      - name: Build (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          bazel build //src:ascii-chat //lib:all ${{ matrix.bazel-config }}

      # Verify build
      - name: Verify build (Unix)
        if: matrix.os != 'Windows'
        run: |
          echo "=== Verifying build artifacts ==="
          ls -la bazel-bin/src/
          if [ -f "bazel-bin/src/ascii-chat" ]; then
            echo "Build successful! Found ascii-chat"
            ./bazel-bin/src/ascii-chat --version || true
          else
            echo "ERROR: ascii-chat binary not found!"
            exit 1
          fi

      - name: Verify build (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Verifying build artifacts ==="
          Get-ChildItem -Path bazel-bin/src/
          if (Test-Path "bazel-bin/src/ascii-chat.exe") {
            Write-Host "Build successful! Found ascii-chat.exe"
          } else {
            Write-Host "ERROR: ascii-chat.exe not found!"
            exit 1
          }

      # Upload artifacts
      - name: Prepare artifacts (Unix)
        if: matrix.os != 'Windows'
        run: |
          mkdir -p artifacts/bin artifacts/lib
          cp bazel-bin/src/ascii-chat artifacts/bin/ || true
          cp bazel-bin/lib/*.a artifacts/lib/ 2>/dev/null || true
          cp bazel-bin/lib/*.so artifacts/lib/ 2>/dev/null || true
          cp bazel-bin/lib/*.dylib artifacts/lib/ 2>/dev/null || true

      - name: Prepare artifacts (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/bin, artifacts/lib | Out-Null
          Copy-Item bazel-bin/src/ascii-chat.exe artifacts/bin/ -ErrorAction SilentlyContinue
          Copy-Item bazel-bin/lib/*.lib artifacts/lib/ -ErrorAction SilentlyContinue
          Copy-Item bazel-bin/lib/*.dll artifacts/lib/ -ErrorAction SilentlyContinue

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ascii-chat-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/
          retention-days: 7
