name: Bazel Build

on:
  push:
    branches: [master, main]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'tests/**'
      - 'bazel/**'
      - 'BUILD.bazel'
      - 'MODULE.bazel'
      - 'WORKSPACE*'
      - '.bazelrc'
      - '.github/workflows/bazel.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'tests/**'
      - 'bazel/**'
      - 'BUILD.bazel'
      - 'MODULE.bazel'
      - 'WORKSPACE*'
      - '.bazelrc'
      - '.github/workflows/bazel.yml'
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: Linux
            arch: amd64
            runner: ubuntu-latest
            bazel_config: linux

          # Linux ARM64
          - os: Linux
            arch: arm64
            runner: ubuntu-24.04-arm
            bazel_config: linux

          # macOS AMD64 (Intel)
          - os: macOS
            arch: amd64
            runner: macos-15-intel
            bazel_config: macos

          # macOS ARM64 (Apple Silicon)
          - os: macOS
            arch: arm64
            runner: macos-15
            bazel_config: macos

          # Windows AMD64
          - os: Windows
            arch: amd64
            runner: windows-latest
            bazel_config: windows

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe
          submodules: true

      # Install system dependencies (Linux)
      - name: Install dependencies (Linux)
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            lld \
            libzstd-dev \
            libsodium-dev \
            portaudio19-dev \
            libncurses-dev \
            libxml2-dev

      # Install system dependencies (macOS)
      - name: Install dependencies (macOS)
        if: matrix.os == 'macOS'
        run: |
          brew install \
            zstd \
            libsodium \
            portaudio

      # Install system dependencies (Windows)
      - name: Install dependencies (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # Install vcpkg dependencies
          vcpkg install zstd:x64-windows libsodium:x64-windows portaudio:x64-windows

      # Set up Bazel via Bazelisk
      - name: Set up Bazel
        uses: bazel-contrib/setup-bazel@0.14.0
        with:
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true

      # Configure BuildBuddy remote cache (if API key available)
      - name: Configure BuildBuddy
        if: env.BUILDBUDDY_API_KEY != ''
        env:
          BUILDBUDDY_API_KEY: ${{ secrets.BUILDBUDDY_API_KEY }}
        run: |
          echo "build --remote_cache=grpcs://remote.buildbuddy.io" >> user.bazelrc
          echo "build --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY" >> user.bazelrc

      # Build all targets
      - name: Build
        run: |
          bazel build --config=${{ matrix.bazel_config }} --config=ci //...

      # Verify build artifacts
      - name: Verify build artifacts
        shell: bash
        run: |
          echo "=== Verifying build artifacts ==="
          if [ "${{ matrix.os }}" = "Windows" ]; then
            BINARY="bazel-bin/src/ascii-chat.exe"
          else
            BINARY="bazel-bin/src/ascii-chat"
          fi

          if [ ! -f "$BINARY" ]; then
            echo "ERROR: ascii-chat binary not found at $BINARY!"
            exit 1
          fi

          echo "Build successful! Testing binary:"
          "$BINARY" --version

      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ascii-chat-bazel-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            bazel-bin/src/ascii-chat*
            bazel-bin/lib/*.a
            bazel-bin/lib/*.so
            bazel-bin/lib/*.dylib
          retention-days: 7
