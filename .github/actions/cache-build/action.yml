name: 'Cache CMake Build'
description: 'Cache the configured CMake build directory and ccache outputs across workflow runs.'

inputs:
  build-directory:
    description: 'Absolute or relative path to the configured CMake build directory.'
    required: false
    default: build
  build-cache-key:
    description: 'Additional suffix applied to the build directory cache key (e.g. build type).'
    required: false
    default: ''
  deps-cache-directory:
    description: 'Newline-separated list of dependency cache directories (e.g. .deps-cache). Leave empty to skip.'
    required: false
    default: |
      .deps-cache
      .deps-cache-musl
  deps-cache-key:
    description: 'Additional suffix applied to the dependency cache key.'
    required: false
    default: ''
  cache-deps:
    description: 'Set to false to skip caching dependency directories.'
    required: false
    default: 'true'
  ccache-directory:
    description: 'Path to the ccache directory to cache.'
    required: false
    default: ~/.ccache
  ccache-cache-key:
    description: 'Additional suffix applied to the ccache cache key (e.g. target triple).'
    required: false
    default: ''
  cache-ccache:
    description: 'Set to false to skip managing the ccache directory.'
    required: false
    default: 'true'
  cache-version:
    description: 'Version string used to invalidate both caches when inputs change.'
    required: false
    default: v1

runs:
  using: composite
  steps:
    - name: Prepare cache keys
      id: cache-config
      shell: bash
      env:
        BUILD_SUFFIX_INPUT: ${{ inputs.build-cache-key }}
        DEPS_SUFFIX_INPUT: ${{ inputs.deps-cache-key }}
        CCACHE_SUFFIX_INPUT: ${{ inputs.ccache-cache-key }}
        CACHE_HASH: ${{ hashFiles('CMakeLists.txt', 'cmake/**/*.cmake') }}
      run: |
        build_suffix="$CACHE_HASH"
        deps_suffix="$CACHE_HASH"
        ccache_suffix="$CACHE_HASH"

        if [ -n "$BUILD_SUFFIX_INPUT" ]; then
          build_suffix="${BUILD_SUFFIX_INPUT}-${CACHE_HASH}"
        fi

        if [ -n "$DEPS_SUFFIX_INPUT" ]; then
          deps_suffix="${DEPS_SUFFIX_INPUT}-${CACHE_HASH}"
        fi

        if [ -n "$CCACHE_SUFFIX_INPUT" ]; then
          ccache_suffix="${CCACHE_SUFFIX_INPUT}-${CACHE_HASH}"
        fi

        echo "build_suffix=${build_suffix}" >> "$GITHUB_OUTPUT"
        echo "deps_suffix=${deps_suffix}" >> "$GITHUB_OUTPUT"
        echo "ccache_suffix=${ccache_suffix}" >> "$GITHUB_OUTPUT"

    - name: Ensure cache directories exist
      shell: bash
      run: |
        mkdir -p "${{ inputs.build-directory }}"
        if [ "${{ inputs.cache-deps }}" = "true" ] && [ -n "${{ inputs.deps-cache-directory }}" ]; then
          while IFS= read -r dep_dir; do
            [ -z "$dep_dir" ] && continue
            mkdir -p "$dep_dir"
          done <<< "${{ inputs.deps-cache-directory }}"
        fi
        if [ "${{ inputs.cache-ccache }}" = "true" ]; then
          mkdir -p "${{ inputs.ccache-directory }}"
          echo "CCACHE_DIR=${{ inputs.ccache-directory }}" >> "${GITHUB_ENV}"
        fi

    - name: Cache build directory
      id: cache-build-dir
      uses: actions/cache@v4
      with:
        path: ${{ inputs.build-directory }}
        key: ${{ format('{0}-build-{1}-{2}-{3}-{4}', inputs.cache-version, runner.os, github.workflow, github.job, steps.cache-config.outputs.build_suffix) }}
        restore-keys: |
          ${{ format('{0}-build-{1}-{2}-{3}-', inputs.cache-version, runner.os, github.workflow, github.job) }}
          ${{ format('{0}-build-{1}-{2}-', inputs.cache-version, runner.os, github.workflow) }}
          ${{ format('{0}-build-{1}-', inputs.cache-version, runner.os) }}
        save-always: true

    - name: Cache dependency directories
      if: inputs.cache-deps == 'true' && inputs.deps-cache-directory != ''
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: ${{ inputs.deps-cache-directory }}
        key: ${{ format('{0}-deps-{1}-{2}-{3}-{4}', inputs.cache-version, runner.os, github.workflow, github.job, steps.cache-config.outputs.deps_suffix) }}
        restore-keys: |
          ${{ format('{0}-deps-{1}-{2}-{3}-', inputs.cache-version, runner.os, github.workflow, github.job) }}
          ${{ format('{0}-deps-{1}-{2}-', inputs.cache-version, runner.os, github.workflow) }}
          ${{ format('{0}-deps-{1}-', inputs.cache-version, runner.os) }}
        save-always: true

    - name: Cache ccache directory
      if: inputs.cache-ccache == 'true'
      id: cache-ccache
      uses: actions/cache@v4
      with:
        path: ${{ inputs.ccache-directory }}
        key: ${{ format('{0}-ccache-{1}-{2}', inputs.cache-version, runner.os, steps.cache-config.outputs.ccache_suffix) }}
        restore-keys: |
          ${{ format('{0}-ccache-{1}-', inputs.cache-version, runner.os) }}
        save-always: true

