name: 'Install Dependencies'
description: 'Install and cache build dependencies for ASCII-Chat'
inputs:
  os:
    description: 'Operating system (ubuntu or macos)'
    required: true
  extra-packages:
    description: 'Additional packages to install (space-separated)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Cache Homebrew (macOS)
      if: inputs.os == 'macos'
      id: cache-homebrew
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /opt/homebrew/Cellar
          /opt/homebrew/var
        key: ${{ runner.os }}-${{ runner.arch }}-deps-${{ hashFiles('.github/actions/install-deps/action.yml') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-deps-

    - name: Cache APT (Ubuntu)
      if: inputs.os == 'ubuntu'
      id: cache-apt
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt/archives
          /var/lib/apt/lists
        key: ${{ runner.os }}-${{ runner.arch }}-deps-${{ hashFiles('.github/actions/install-deps/action.yml') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-deps-

    - name: Check if packages exist (macOS)
      if: inputs.os == 'macos'
      id: check-packages
      shell: bash
      run: |
        # Check if all required packages are already installed
        if brew list portaudio &>/dev/null && brew list libsodium &>/dev/null && brew list criterion &>/dev/null; then
          echo "packages-exist=true" >> $GITHUB_OUTPUT
          echo "All required packages already installed"
        else
          echo "packages-exist=false" >> $GITHUB_OUTPUT
          echo "Some packages need installation"
        fi

    - name: Install dependencies (macOS)
      if: inputs.os == 'macos' && steps.check-packages.outputs.packages-exist != 'true'
      shell: bash
      run: |
        # Install missing dependencies
        echo "Installing Homebrew dependencies..."
        brew update
        
        # Install base dependencies
        brew install portaudio libsodium criterion
        
        # Install extra packages if provided
        if [[ -n "${{ inputs.extra-packages }}" ]]; then
          brew install ${{ inputs.extra-packages }}
        fi

    - name: Set up build environment (macOS)
      if: inputs.os == 'macos'
      shell: bash
      run: |
        # Set up pkg-config path for Homebrew packages (always needed)
        echo "PKG_CONFIG_PATH=/opt/homebrew/lib/pkgconfig:/opt/homebrew/share/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
        echo "CPPFLAGS=-I/opt/homebrew/include:$CPPFLAGS" >> $GITHUB_ENV
        echo "LDFLAGS=-L/opt/homebrew/lib:$LDFLAGS" >> $GITHUB_ENV
        
        # Also set them in the current step for immediate use
        export PKG_CONFIG_PATH="/opt/homebrew/lib/pkgconfig:/opt/homebrew/share/pkgconfig:$PKG_CONFIG_PATH"
        export CPPFLAGS="-I/opt/homebrew/include:$CPPFLAGS"
        export LDFLAGS="-L/opt/homebrew/lib:$LDFLAGS"
        
        # Verify they're set correctly
        echo "PKG_CONFIG_PATH is now: $PKG_CONFIG_PATH"
        echo "CPPFLAGS is now: $CPPFLAGS"
        echo "LDFLAGS is now: $LDFLAGS"

    - name: Install dependencies (Ubuntu)
      if: inputs.os == 'ubuntu' && steps.cache-apt.outputs.cache-hit != 'true'
      shell: bash
      run: |
        # Cache miss - install dependencies
        sudo apt-get update
        
        # Install base dependencies
        sudo apt-get install -y \
          clang \
          libv4l-dev \
          zlib1g-dev \
          portaudio19-dev \
          libsodium-dev \
          libcriterion-dev \
          pkg-config
        
        # Install extra packages if provided
        if [[ -n "${{ inputs.extra-packages }}" ]]; then
          sudo apt-get install -y ${{ inputs.extra-packages }}
        fi