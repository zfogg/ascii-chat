services:
  ascii-chat-tests:
    image: ascii-chat-tests
    build:
      context: ..
      dockerfile: tests/Dockerfile

    # Mount source code and cache volumes
    volumes:
      # Source code (read-write needed for Docker to create nested mount points)
      # Build artifacts stored in named volume to avoid macOS timestamp issues
      - ..:/app

      # Output directory for copying files out of the container
      - ../docker_out:/tmp/out

      # Build directory as named volume (fixes Ninja .ninja_deps timestamp issues)
      # On macOS, volume mounts lose timestamp precision, invalidating Ninja's deps
      # By keeping build artifacts in container filesystem, timestamps stay consistent
      - build-data:/app/build_docker

      # ccache volume for persistent compilation cache
      # This persists between container runs for faster rebuilds
      - ccache-data:/ccache

      # Dependency cache volume for FetchContent and musl builds
      # CMakeLists.txt automatically uses .deps-cache/docker/ when TESTING=1
      # Volume mounted at root to preserve .patch_applied files and docker/ subdirectory
      # Path structure: .deps-cache/docker/<BuildType>/ and .deps-cache/docker/<BuildType>/musl/
      - deps-cache-data:/app/.deps-cache

    # Required for AddressSanitizer/LeakSanitizer to work in container
    cap_add:
      - SYS_PTRACE

    # Run tests by default
    # Use build_docker directory (build is for native OS)
    command: >
      sh -c "cmake --preset default -B build_docker &&
             cmake --build build_docker &&
             ./tests/scripts/run_tests.sh"

    # Optional: Override command for interactive shell
    # docker-compose run --rm ascii-chat-tests /bin/bash

    environment:
      # ccache configuration
      - CCACHE_DIR=/ccache
      - CCACHE_UMASK=002
      - CCACHE_HARDLINK=true
      - CCACHE_NLEVELS=2

      # Build configuration - Ninja is much faster than Make
      - CMAKE_GENERATOR=Ninja
      - CMAKE_BUILD_TYPE=Debug

      # Test configuration
      - TESTING=1
      - CRITERION_TEST=1

      # Security: Skip known_hosts checking for integration tests
      - ASCII_CHAT_INSECURE_NO_HOST_IDENTITY_CHECK=1

      # AddressSanitizer configuration
      - ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer

      # LeakSanitizer workaround for Docker
      # LSAN requires ptrace which may not work in all Docker configurations
      # even with SYS_PTRACE capability (depends on host security policies)
      - LSAN_OPTIONS=detect_leaks=0

# Named volumes for persistent caching
volumes:
  build-data:
    driver: local
    # Stores build artifacts (object files, .ninja_deps, executables)
    # Must be in container filesystem to avoid macOS timestamp precision issues
    # that cause Ninja to rebuild everything on every invocation

  ccache-data:
    driver: local
    # Optional: specify host path for easier access
    # driver_opts:
    #   type: none
    #   device: ${PWD}/.docker-ccache
    #   o: bind

  deps-cache-data:
    driver: local
    # Stores FetchContent dependencies (mimalloc, bearssl, etc.) and musl builds
    # Also stores .patch_applied files at root level
    # Separated from ccache for easier management and cleanup
    # Path structure inside container: /app/.deps-cache/docker/<BuildType>/
    # Optional: specify host path for easier access
    # driver_opts:
    #   type: none
    #   device: ${PWD}/.deps-cache
    #   o: bind
