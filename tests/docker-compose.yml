services:
  ascii-chat-tests:
    build:
      context: ..
      dockerfile: tests/Dockerfile

    # Mount source code and cache volumes
    volumes:
      # Source code (read-only to prevent accidental modifications)
      # Build artifacts stored in named volume to avoid macOS timestamp issues
      - ..:/app:ro

      # Build directory as named volume (fixes Ninja .ninja_deps timestamp issues)
      # On macOS, volume mounts lose timestamp precision, invalidating Ninja's deps
      # By keeping build artifacts in container filesystem, timestamps stay consistent
      - build-data:/app/build_docker:rw

      # Secondary build directory for ad-hoc docker builds (read-write)
      - docker-build-data:/app/docker_build:rw

      # ccache volume for persistent compilation cache
      # This persists between container runs for faster rebuilds
      - ccache-data:/ccache:rw

      # Dependency cache volume for FetchContent and musl builds
      # CMakeLists.txt automatically uses .deps-cache-docker/ when TESTING=1
      # Path structure: .deps-cache-docker/<BuildType>/ and .deps-cache-docker/<BuildType>/musl/
      - deps-cache-data:/app/.deps-cache-docker:rw

    # Run tests by default
    # Use build_docker directory (build is for native OS)
    command: >
      sh -c "cmake --preset default -B build_docker &&
             cmake --build build_docker &&
             ./tests/scripts/run_tests.sh"

    # Optional: Override command for interactive shell
    # docker-compose run ascii-chat-tests /bin/bash

    # Environment variables (can be overridden)
    environment:
      # ccache configuration (from Dockerfile)
      - CCACHE_DIR=/ccache
      - CCACHE_UMASK=002
      - CCACHE_HARDLINK=true
      - CCACHE_NLEVELS=2

      # Build configuration
      - CMAKE_BUILD_TYPE=Debug

      # Test configuration
      - TESTING=1
      - CRITERION_TEST=1

      # AddressSanitizer configuration
      - ASAN_SYMBOLIZER_PATH=/usr/bin/llvm-symbolizer

# Named volumes for persistent caching
volumes:
  build-data:
    driver: local
    # Stores build artifacts (object files, .ninja_deps, executables)
    # Must be in container filesystem to avoid macOS timestamp precision issues
    # that cause Ninja to rebuild everything on every invocation

  ccache-data:
    driver: local
    # Optional: specify host path for easier access
    # driver_opts:
    #   type: none
    #   device: ${PWD}/.docker-ccache
    #   o: bind

  deps-cache-data:
    driver: local
    # Stores FetchContent dependencies (mimalloc, bearssl, etc.) and musl builds
    # Separated from ccache for easier management and cleanup
    # Path structure inside container: /app/.deps-cache-docker/<BuildType>/
    # Optional: specify host path for easier access
    # driver_opts:
    #   type: none
    #   device: ${PWD}/.deps-cache-docker
    #   o: bind

  docker-build-data:
    driver: local
    # Stores ad-hoc build trees created under /app/docker_build (e.g. docker_build/extra_test_build)
    # Allows writable mount separate from primary build_docker directory
