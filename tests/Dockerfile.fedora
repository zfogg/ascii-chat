# Dockerfile for building RPM packages
# Uses Fedora for yum/rpmbuild compatibility

FROM fedora:latest

# Set environment
ENV CC=clang \
  CXX=clang++ \
  LANG=C.UTF-8 \
  LC_ALL=C.UTF-8 \
  TESTING=1

# Configure ccache for Docker volume caching
ENV CCACHE_DIR=/ccache \
  CCACHE_UMASK=002 \
  CCACHE_HARDLINK=true \
  CCACHE_NLEVELS=2

# Install base dependencies
RUN dnf install -y \
  sudo \
  ca-certificates \
  git \
  wget \
  && dnf clean all

# Install clang-21 and llvm-21 from Fedora repos
RUN dnf install -y \
  clang \
  llvm \
  lld \
  && dnf clean all && \
  if command -v clang-21 >/dev/null 2>&1; then \
    update-alternatives --install /usr/bin/clang clang /usr/bin/clang-21 100 && \
    update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-21 100; \
  fi

# Set working directory
WORKDIR /app

# Copy deps script
COPY scripts/deps.sh /tmp/deps.sh
RUN chmod +x /tmp/deps.sh

# Run deps script to install build dependencies
RUN /tmp/deps.sh

# Default to bash for interactive use
CMD ["/bin/bash"]
