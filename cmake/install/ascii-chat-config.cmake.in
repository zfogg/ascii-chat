# ascii-chat CMake Package Config
#
# Usage:
#   find_package(ascii-chat REQUIRED)
#   target_link_libraries(your-target PRIVATE ascii-chat::shared)  # dynamic
#   target_link_libraries(your-target PRIVATE ascii-chat::static)  # static
#
# Targets:
#   ascii-chat::shared - Shared library (requires runtime deps)
#   ascii-chat::static - Static library (self-contained, no external deps)

cmake_minimum_required(VERSION 3.16)

# Compute install prefix from this file's location
get_filename_component(_IMPORT_PREFIX "${CMAKE_CURRENT_LIST_FILE}" PATH)
get_filename_component(_IMPORT_PREFIX "${_IMPORT_PREFIX}" PATH)
get_filename_component(_IMPORT_PREFIX "${_IMPORT_PREFIX}" PATH)
get_filename_component(_IMPORT_PREFIX "${_IMPORT_PREFIX}" PATH)

set(_INCLUDE_DIRS "${_IMPORT_PREFIX}/include" "${_IMPORT_PREFIX}/include/ascii-chat")

# =============================================================================
# ascii-chat::shared - Dynamic library
# =============================================================================
if(NOT TARGET ascii-chat::shared)
    add_library(ascii-chat::shared SHARED IMPORTED)
    set_target_properties(ascii-chat::shared PROPERTIES
        IMPORTED_LOCATION "${_IMPORT_PREFIX}/lib/libasciichat@CMAKE_SHARED_LIBRARY_SUFFIX@"
        INTERFACE_INCLUDE_DIRECTORIES "${_INCLUDE_DIRS}"
    )

    # Shared library needs runtime dependencies
    find_package(PkgConfig QUIET)
    if(PkgConfig_FOUND)
        pkg_check_modules(_LIBSODIUM QUIET IMPORTED_TARGET libsodium)
        pkg_check_modules(_ZSTD QUIET IMPORTED_TARGET libzstd)
        pkg_check_modules(_PORTAUDIO QUIET IMPORTED_TARGET portaudio-2.0)

        if(_LIBSODIUM_FOUND AND _ZSTD_FOUND AND _PORTAUDIO_FOUND)
            set_property(TARGET ascii-chat::shared APPEND PROPERTY
                INTERFACE_LINK_LIBRARIES
                    PkgConfig::_LIBSODIUM
                    PkgConfig::_ZSTD
                    PkgConfig::_PORTAUDIO
            )
        endif()
    endif()
endif()

# =============================================================================
# ascii-chat::static - FAT Static library (self-contained)
# =============================================================================
# All external dependencies (libsodium, zstd, portaudio, opus, mimalloc, webrtc)
# are baked into the archive. Only platform system libraries need to be linked.
if(NOT TARGET ascii-chat::static)
    add_library(ascii-chat::static STATIC IMPORTED)
    set_target_properties(ascii-chat::static PROPERTIES
        IMPORTED_LOCATION "${_IMPORT_PREFIX}/lib/libasciichat.a"
        INTERFACE_INCLUDE_DIRECTORIES "${_INCLUDE_DIRS}"
    )

    # Static library only needs system libs (everything else is baked in)
    find_package(Threads QUIET)
    if(Threads_FOUND)
        set_property(TARGET ascii-chat::static APPEND PROPERTY
            INTERFACE_LINK_LIBRARIES Threads::Threads
        )
    endif()

    # Platform-specific system libraries
    if(APPLE)
        set_property(TARGET ascii-chat::static APPEND PROPERTY
            INTERFACE_LINK_LIBRARIES
                "-framework Foundation"
                "-framework AVFoundation"
                "-framework CoreMedia"
                "-framework CoreVideo"
                "-framework CoreAudio"
                "-framework AudioUnit"
                "-framework AudioToolbox"
                "-framework CoreServices"
                c++
        )
    elseif(UNIX)
        set_property(TARGET ascii-chat::static APPEND PROPERTY
            INTERFACE_LINK_LIBRARIES m dl stdc++
        )
    endif()
endif()

# Package info
set(ascii-chat_FOUND TRUE)
set(ascii-chat_VERSION "@PROJECT_VERSION@")
set(ascii-chat_INCLUDE_DIRS ${_INCLUDE_DIRS})

unset(_IMPORT_PREFIX)
unset(_INCLUDE_DIRS)

if(NOT ascii-chat_FIND_QUIETLY)
    message(STATUS "Found ascii-chat: ${ascii-chat_VERSION}")
endif()
