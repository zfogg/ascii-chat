#!/bin/sh

# Display usage information
cpack_usage()
{
  cat <<EOF
Usage: $0 [options]
Options: [defaults in brackets after descriptions]
  --help            print this message
  --version         print cmake installer version
  --prefix=dir      directory in which to install
                    [default: /usr/local]
  --include-subdir  include the @CPACK_PACKAGE_NAME@ subdirectory
  --exclude-subdir  exclude the @CPACK_PACKAGE_NAME@ subdirectory
                    [default: exclude]
  --skip-license    accept license
EOF
  exit 1
}

cpack_echo_exit()
{
  echo $1
  exit 1
}

# Display version
cpack_version()
{
  echo "@CPACK_PACKAGE_NAME@ Installer Version: @CPACK_PACKAGE_VERSION@, Copyright (c) @CPACK_PACKAGE_VENDOR@"
}

# Helper function to fix windows paths
cpack_fix_slashes()
{
  echo "$1" | sed 's/\\/\//g'
}

interactive=TRUE
cpack_skip_license=FALSE
# Leave cpack_include_subdir unset - will be determined by command line flags or user prompt
# (defaults to FALSE for FHS-compliant installation when user is prompted)
cpack_include_subdir=""
# Default to /usr/local instead of current directory
cpack_prefix_dir="/usr/local"

for a in "$@"; do
  if echo $a | grep "^--prefix=" > /dev/null 2> /dev/null; then
    cpack_prefix_dir=`echo $a | sed "s/^--prefix=//"`
    cpack_prefix_dir=`cpack_fix_slashes "${cpack_prefix_dir}"`
  fi
  if echo $a | grep "^--help" > /dev/null 2> /dev/null; then
    cpack_usage
  fi
  if echo $a | grep "^--version" > /dev/null 2> /dev/null; then
    cpack_version
    exit 0
  fi
  if echo $a | grep "^--include-subdir" > /dev/null 2> /dev/null; then
    cpack_include_subdir=TRUE
  fi
  if echo $a | grep "^--exclude-subdir" > /dev/null 2> /dev/null; then
    cpack_include_subdir=FALSE
  fi
  if echo $a | grep "^--skip-license" > /dev/null 2> /dev/null; then
    cpack_skip_license=TRUE
  fi
done

cpack_version
echo "This is a self-extracting archive."
toplevel="`pwd`"
if [ "x${cpack_prefix_dir}x" != "x.x" ]
then
  toplevel="${cpack_prefix_dir}"
fi

echo "The archive will be extracted to: ${toplevel}"

# Show license if not skipped
if [ "x${cpack_skip_license}x" != "xTRUEx" ]
then
  echo ""
  echo "If you want to stop extracting, please press <ctrl-C>."
  more << '____cpack__here_doc____'
@CPACK_RESOURCE_FILE_LICENSE_CONTENT@
____cpack__here_doc____
  echo
  while true
    do
      echo "Do you accept the license? [yn]: "
      read line leftover
      case ${line} in
        y* | Y*)
          cpack_license_accepted=TRUE
          break;;
        n* | N* | q* | Q* | e* | E*)
          echo "License not accepted. Exiting ..."
          exit 1;;
      esac
    done
fi

# Ask user about subdirectory (default to NO for FHS-compliant installation)
# Only ask if not already specified via command line flags
if [ "x${cpack_include_subdir}x" = "xx" ]
then
  echo ""
  echo "By default the @CPACK_PACKAGE_NAME@ will be installed to:"
  echo "  \"${toplevel}/bin/@CPACK_PACKAGE_NAME@\""
  echo "  \"${toplevel}/share/doc/@CPACK_PACKAGE_NAME@/\""
  echo ""
  echo "Do you want to include the @CPACK_PACKAGE_NAME@ subdirectory?"
  echo "Saying yes will install to: \"${toplevel}/@CPACK_PACKAGE_NAME@/\" [yn]: "
  read line leftover
  cpack_include_subdir=FALSE
  case ${line} in
    y* | Y*)
      cpack_include_subdir=TRUE
      ;;
  esac
fi

if [ "x${cpack_include_subdir}x" = "xTRUEx" ]
then
  toplevel="${toplevel}/@CPACK_PACKAGE_NAME@"
  mkdir -p "${toplevel}"
fi
echo
echo "Using target directory: ${toplevel}"
echo "Extracting, please wait..."
echo ""

# Take the archive portion of this file and pipe it to tar
# The NUMERIC parameter in this command should be one more than the number of lines in this header file
# There are tails which don't understand the "-n" argument (e.g. on SunOS)
# OTOH there are tails which complain when not using the "-n" argument (e.g. GNU)
# So at first try to tail some file to see if tail fails if used with "-n"
# If so, don't use "-n"
use_new_tail_syntax="-n"
tail $use_new_tail_syntax +1 "$0" > /dev/null 2> /dev/null || use_new_tail_syntax=""

extractor="pax -r"
command -v pax > /dev/null 2> /dev/null || extractor="tar xf -"

tail $use_new_tail_syntax +###CPACK_HEADER_LENGTH### "$0" | gunzip | (cd "${toplevel}" && ${extractor}) || cpack_echo_exit "Problem unpacking the @CPACK_PACKAGE_FILE_NAME@"

echo "Unpacking finished successfully"

# Run post-install script if present
if [ -x "${toplevel}/@CPACK_PACKAGE_FILE_NAME@-@CPACK_PACKAGE_VERSION@-post.sh" ]; then
  echo "Running post-install script"
  "${toplevel}/@CPACK_PACKAGE_FILE_NAME@-@CPACK_PACKAGE_VERSION@-post.sh"
fi

exit 0
#-----------------------------------------------------------
#      Start of TAR.GZ file
#-----------------------------------------------------------;
