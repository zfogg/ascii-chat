#!/bin/bash
# Wrapper to rename object files before archiving
# This avoids "duplicate member name" warnings when combining static libraries
set -e

# Extract the output archive and object directory from args
OUTPUT_ARCHIVE=""
for arg in "$@"; do
    case "$arg" in
        *.a|*.lib)
            OUTPUT_ARCHIVE="$arg"
            break
            ;;
    esac
done

if [[ -n "$OUTPUT_ARCHIVE" ]]; then
    # Get the object directory from the archive path
    LIB_BASENAME="$(basename "$OUTPUT_ARCHIVE")"
    case "$LIB_BASENAME" in
        *.a) LIB_NAME="${LIB_BASENAME%.a}" ;;
        *.lib) LIB_NAME="${LIB_BASENAME%.lib}" ;;
        *) LIB_NAME="$LIB_BASENAME" ;;
    esac
    # Strip 'lib' prefix if present
    LIB_NAME="${LIB_NAME#lib}"
    OBJ_DIR="@CMAKE_BINARY_DIR@/CMakeFiles/${LIB_NAME}.dir"
    if [[ -d "$OBJ_DIR" ]]; then
        # Rename objects before archiving and update args
        @CMAKE_SOURCE_DIR@/cmake/scripts/rename_objects.sh "$OBJ_DIR" "@CMAKE_SOURCE_DIR@" >/dev/null 2>&1 || true

        # Update arguments to use renamed files
        NEW_ARGS=()
        for arg in "$@"; do
            if [[ "$arg" == *.o || "$arg" == *.obj ]] && [[ "$arg" == CMakeFiles/* ]]; then
                # Get the relative path after CMakeFiles/target.dir/
                rel_path="${arg#CMakeFiles/*/}"
                new_name="${rel_path//\//_}"
                new_name="${new_name//\\/_}"
                new_path="${OBJ_DIR}/${new_name}"
                if [[ -f "$new_path" ]]; then
                    NEW_ARGS+=("$new_path")
                elif [[ -f "$arg" ]]; then
                    NEW_ARGS+=("$arg")
                else
                    NEW_ARGS+=("$arg")
                fi
            else
                NEW_ARGS+=("$arg")
            fi
        done
        set -- "${NEW_ARGS[@]}"
    fi
fi

# Run the actual archiver (use REAL_AR from environment or default)
REAL_AR="${REAL_AR:-@REAL_AR@}"
AR_ARGS=("$@")
if [[ -n "$OUTPUT_ARCHIVE" ]]; then
    NORMALIZED_ARCHIVE="${OUTPUT_ARCHIVE//\\//}"
    for i in "${!AR_ARGS[@]}"; do
        if [[ "${AR_ARGS[$i]}" == "$OUTPUT_ARCHIVE" ]]; then
            AR_ARGS[$i]="$NORMALIZED_ARCHIVE"
            break
        fi
    done
fi
if [[ "$OUTPUT_ARCHIVE" == *.lib ]]; then
    AR_ARGS=("--format=coff" "${AR_ARGS[@]}")
fi
exec "$REAL_AR" "${AR_ARGS[@]}"
