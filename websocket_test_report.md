# WebSocket Server-Client Test Report

**Date**: 2026-02-21  
**Test Script**: `scripts/test-websocket-server-client.sh`  
**Test Runs**: 2 comprehensive runs with detailed log analysis

## Executive Summary

The WebSocket server **fails to bind to its configured port** during initialization, resulting in complete failure of browser-based client connectivity. The underlying TCP server works correctly, but the WebSocket transport layer is non-functional.

## Root Cause

```
ERROR: lib/network/websocket/server.c:850@websocket_server_init()
SET_ERRNO: Failed to create libwebsockets context 
Code: 41 (Cannot bind to network port)
```

The libwebsockets context creation fails during server startup, preventing the WebSocket server from listening on the specified port.

## Detailed Findings

### Server Side
- ✓ Server initializes successfully and enters accept loop
- ✓ TCP server binds to ports 31058 (IPv4/IPv6 dual-stack)
- ✓ Audio mixer initialized and operational
- ✓ mDNS service advertising works
- ✓ All non-websocket subsystems functional
- **✗ WebSocket server fails to bind** - returns error code 41
- ✗ Warning: "Failed to initialize WebSocket server - browser clients will not be supported"

### Client Side
- ✓ Client initializes successfully
- ✓ Audio pipeline created (48kHz, 128kbps Opus)
- ✓ Audio callbacks executing (700+ callbacks in 5 seconds)
- ✗ **CRITICAL**: WebSocket connection fails with ECONNREFUSED
- ✗ No network data transmission occurs
- ✗ Network playback buffer underruns at 100% (0 samples/480 expected)

## Impact Assessment

| Component | Status | Impact |
|-----------|--------|--------|
| Browser Client Support | **BROKEN** | Cannot connect via WebSocket |
| Direct TCP Client | Working | Can still connect using TCP protocol |
| Audio System | Working | Properly initialized and operational |
| Server Stability | Working | No crashes or corruption |
| Memory Management | Working | No leaks or corruption |

## Network Connectivity Flow

```
Test Initialization:
  ✓ Server binds TCP port 31058
  ✓ Server attempts WebSocket bind (port 37909)
  ✗ WebSocket bind FAILS with "Cannot bind to network port"
  → Server continues with TCP only
  
Client Connection Attempt:
  ✓ Client attempts: ws://localhost:37909
  ✗ Connection refused (port not listening)
  → Audio pipeline continues (local buffer, 0% data received)
  
Result: Network connection FAILED
```

## Possible Root Causes

1. **Address Binding Conflict**: Dual-stack (IPv4/IPv6) configuration may have conflicts
2. **Port Already in Use**: Despite random port selection, collision possible
3. **Permission Issue**: May need elevated privileges for port binding
4. **libwebsockets Configuration**: Context creation parameters may be invalid
5. **System Resource Limit**: Port table exhaustion (unlikely but possible)

## Recommended Debugging Steps

1. Check error code 41 mappings in libwebsockets source
2. Add more detailed logging before `lws_create_context()` call:
   - Actual address being bound (0.0.0.0:37909?)
   - Protocol configuration
   - TLS settings
3. Verify port 37909 is not in use: `netstat -tlnp | grep 37909`
4. Try explicit binding to 127.0.0.1 instead of 0.0.0.0
5. Test with smaller port numbers (non-ephemeral range)
6. Check libwebsockets build configuration

## Test Script Observations

The test script correctly:
- Generates random ports to avoid conflicts
- Starts server and waits for initialization
- Starts client with snapshot mode (-S -D 1)
- Waits 5 seconds for data transmission
- Captures logs to `/tmp/ascii-chat-server-*.log` and `/tmp/ascii-chat-client-*.log`
- Detects and reports crashes (none found)

However, it does not detect the websocket binding failure because:
- Warning is logged to file, not printed to stdout
- Script assumes successful initialization based on process startup
- No network-level verification (netstat/ss check)

## Recommendations

1. **Immediate**: Add netstat check to test script to verify listening ports
2. **Short-term**: Improve error logging for websocket initialization failures
3. **Medium-term**: Implement fallback port selection on bind failure
4. **Long-term**: Consider alternative WebSocket library if libwebsockets has reliability issues

---
Generated by automated test analysis (as-axb2w)
