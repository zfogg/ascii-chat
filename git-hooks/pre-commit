#!/usr/bin/env bash

# Get list of staged files
all_staged=$(git diff --cached --name-only --diff-filter=ACM || true)

# Format C/C++ files
c_files=$(echo "$all_staged" | grep -E '\.(c|h|cpp|hpp|m|mm)$' || true)
if [[ -n "$c_files" ]]; then
  for file in $c_files; do
    if [[ -f "$file" ]]; then
      clang-format -i "$file"
    fi
  done

  formatted_files=""
  for file in $c_files; do
    if [[ -f "$file" ]] && git diff --name-only | grep -q "^$file$"; then
      formatted_files="$formatted_files $file"
      git add "$file"
    fi
  done

  if [[ -n "$formatted_files" ]]; then
    echo "ðŸŽ¨ Code formatting applied to:$formatted_files"
  fi
fi

# Build web/ascii-chat.com and git add man pages
if echo "$all_staged" | grep -q "^(web/ascii-chat\.com/|web/packages/)"; then
  cd web/ascii-chat.com
  ./scripts/build.sh
  cd ../..

  # Auto-add generated man page html pages if changed.
  manpage_files=$(command -p ls web/ascii-chat.com/public/ascii-chat*-man*.html)
  for manpage_file in $manpage_files; do
    if [[ -f "$manpage_file" ]] && git diff --name-only "$manpage_file" | grep -q "^$manpage_file$"; then
      git add $manpage_files
      echo "ðŸ“¦ Auto-staged man page asset: $wasm_file"
    fi
  done
fi

# Build web/web.ascii-chat.com and git add WASM assets
web_src_changed=$(echo "$all_staged" | grep -E "^(web/web\.ascii-chat\.com/|src/web/|web/packages/)" | grep -v "^web/web\.ascii-chat\.com/src/wasm/dist/" || true)
if [[ -n "$web_src_changed" ]]; then
  cd web/web.ascii-chat.com
  bun run build
  cd ../..

  # Auto-add WASM compiled assets only if they changed
  wasm_files="web/web.ascii-chat.com/src/wasm/dist/mirror.js web/web.ascii-chat.com/src/wasm/dist/mirror.wasm"
  for wasm_file in $wasm_files; do
    if [[ -f "$wasm_file" ]] && git diff --name-only "$wasm_file" | grep -q "^$wasm_file$"; then
      git add "$wasm_file"
      echo "ðŸ“¦ Auto-staged WASM asset: $wasm_file"
    fi
  done
fi

# Build web/discovery.ascii-chat.com (no auto-add)
if echo "$all_staged" | grep -q "^(web/discovery\.ascii-chat\.com/|web/packages/)"; then
  cd web/discovery.ascii-chat.com
  bun run build
  cd ../..
fi
