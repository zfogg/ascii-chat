#!/usr/bin/env bash

# Get list of staged files
all_staged=$(git diff --cached --name-only --diff-filter=ACM || true)

# Format C/C++ files
c_files=$(echo "$all_staged" | grep -E '\.(c|h|cpp|hpp|m|mm)$' || true)
if [[ -n "$c_files" ]]; then
    for file in $c_files; do
        if [[ -f "$file" ]]; then
            clang-format -i "$file"
        fi
    done

    formatted_files=""
    for file in $c_files; do
        if [[ -f "$file" ]] && git diff --name-only | grep -q "^$file$"; then
            formatted_files="$formatted_files $file"
            git add "$file"
        fi
    done

    if [[ -n "$formatted_files" ]]; then
        echo "ðŸŽ¨ Code formatting applied to:$formatted_files"
    fi
fi

# Build web/ascii-chat.com and commit man pages
if echo "$all_staged" | grep -q "^web/ascii-chat\.com/"; then
    cd web/ascii-chat.com
    ./scripts/build.sh
    cd ../..
fi

# Build web/web.ascii-chat.com and auto-add changed WASM assets
# Only auto-add WASM if source files changed (not just WASM dist files)
web_src_changed=$(echo "$all_staged" | grep -E "^(web/web\.ascii-chat\.com/|src/web/)" | grep -v "^web/web\.ascii-chat\.com/src/wasm/dist/" || true)
if [[ -n "$web_src_changed" ]]; then
    cd web/web.ascii-chat.com
    bun run build
    cd ../..

    # Auto-add WASM compiled assets if they changed
    wasm_files="web/web.ascii-chat.com/src/wasm/dist/mirror.js web/web.ascii-chat.com/src/wasm/dist/mirror.wasm"
    for wasm_file in $wasm_files; do
        if [[ -f "$wasm_file" ]] && git diff --name-only "$wasm_file" | grep -q "^$wasm_file$"; then
            git add "$wasm_file"
            echo "ðŸ“¦ Auto-staged WASM asset: $wasm_file"
        fi
    done
fi

# Build web/discovery.ascii-chat.com (no auto-add)
if echo "$all_staged" | grep -q "^web/discovery\.ascii-chat\.com/"; then
    cd web/discovery.ascii-chat.com
    bun run build
    cd ../..
fi
