#!/usr/bin/env bash

# Get list of C/C++ files that are staged for commit
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h|cpp|hpp|m|mm)$' || true)

if [[ -z "$staged_files" ]]; then
    exit 0
fi

# Format only the staged files
for file in $staged_files; do
    if [[ -f "$file" ]]; then
        clang-format -i "$file"
    fi
done

# Re-stage any files that were modified by formatting
formatted_files=""
for file in $staged_files; do
    if [[ -f "$file" ]] && git diff --name-only | grep -q "^$file$"; then
        formatted_files="$formatted_files $file"
        git add "$file"
    fi
done

# Show what was formatted
if [[ -n "$formatted_files" ]]; then
    echo "ðŸŽ¨ Code formatting applied to:$formatted_files"
fi
