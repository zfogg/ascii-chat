#!/usr/bin/env bash

set -e

# Get list of staged files
all_staged=$(git diff --cached --name-only --diff-filter=ACM || true)

# Format C/C++ files
c_files=$(echo "$all_staged" | grep -E '\.(c|h|cpp|hpp|m|mm)$' || true)
if [[ -n "$c_files" ]]; then
  for file in $c_files; do
    if [[ -f "$file" ]]; then
      clang-format -i "$file"
    fi
  done

  formatted_files=""
  for file in $c_files; do
    if [[ -f "$file" ]] && git diff --name-only | grep -q "^$file$"; then
      formatted_files="$formatted_files $file"
      git add "$file"
    fi
  done

  if [[ -n "$formatted_files" ]]; then
    echo "ðŸŽ¨ Code formatting applied to:$formatted_files"
  fi
fi

# Function to check and format web project
check_web_project() {
  local project_dir=$1
  local project_name=$(basename "$project_dir")

  if echo "$all_staged" | grep -q "^${project_dir#./}"; then
    echo "ðŸ“ Checking $project_name..."
    cd "$project_dir"

    # Format staged files and git add them
    echo "  âœ“ Formatting..."
    staged_files=$(git diff --cached --name-only --diff-filter=ACM || true)
    if [[ -n "$staged_files" ]]; then
      bun run format > /dev/null 2>&1
      # Git add any staged files that were changed by formatting
      echo "$staged_files" | while read file; do
        if [[ -f "$file" ]] && git diff "$file" | grep -q .; then
          git add "$file"
        fi
      done
    fi

    # Type check
    echo "  âœ“ Type checking and linting..."
    bun run build || {
      echo "  âœ— Build failed in $project_name"
      cd - > /dev/null
      return 1
    }

  fi
}

# Check each web project
check_web_project "web/web.ascii-chat.com" || exit 1
check_web_project "web/ascii-chat.com" || exit 1
check_web_project "web/discovery.ascii-chat.com" || exit 1

# Build web/ascii-chat.com and git add man pages
if echo "$all_staged" | grep -q "^(web/ascii-chat\.com/|web/packages/)"; then
  manpage_files=$(command -p ls web/ascii-chat.com/public/ascii-chat*-man*.html 2>/dev/null || true)
  for manpage_file in $manpage_files; do
    if [[ -f "$manpage_file" ]] && git diff --name-only "$manpage_file" | grep -q "^$manpage_file$"; then
      git add $manpage_files
      echo "ðŸ“¦ Auto-staged man page asset: $manpage_file"
    fi
  done
fi

# Build web/web.ascii-chat.com and git add WASM assets
web_src_changed=$(echo "$all_staged" | grep -E "^(web/web\.ascii-chat\.com/|src/web/|web/packages/)" | grep -v "^web/web\.ascii-chat\.com/src/wasm/dist/" || true)
if [[ -n "$web_src_changed" ]]; then
  wasm_files="web/web.ascii-chat.com/src/wasm/dist/mirror.js web/web.ascii-chat.com/src/wasm/dist/mirror.wasm"
  for wasm_file in $wasm_files; do
    if [[ -f "$wasm_file" ]] && git diff --name-only "$wasm_file" | grep -q "^$wasm_file$"; then
      git add "$wasm_file"
      echo "ðŸ“¦ Auto-staged WASM asset: $wasm_file"
    fi
  done
fi

echo "âœ… Pre-commit checks passed"
