# Codecov configuration for ascii-chat
# This configuration uses Components to organize coverage reporting by functionality

# Global settings
codecov:
  # Use the default branch from Git
  branch: master
  # Reject reports older than 12 hours
  max_report_age: "12h"
  # Enable notifications and integrations
  notify:
    # Enable GitHub PR comments with coverage details
    require_ci_to_pass: false
    after_n_builds: 1

# Coverage configuration
coverage:
  # Overall precision and display settings
  precision: 2
  round: down
  range: 60..100

  # Status checks configuration
  status:
    # Default rules applied to all status checks
    default_rules:
      flag_coverage_not_uploaded_behavior: include

    # Project-level status checks
    project:
      # Overall project coverage
      default:
        target: auto
        threshold: 2%
        branches:
          - master
          - main
          - palettes

      # Core server functionality (most critical)
      server_core:
        target: 50%
        threshold: 2%
        paths:
          - "src/server/**/*"
          - "lib/network/**/*"

      # Client functionality
      client_core:
        target: 50%
        threshold: 2%
        paths:
          - "src/client/**/*"

      # ASCII conversion engine (core feature)
      ascii_engine:
        target: 50%
        threshold: 2%
        paths:
          - "lib/image2ascii/**/*"

      # Video processing pipeline
      video_processing:
        target: 50%
        threshold: 2%
        paths:
          - "lib/image2ascii/image.*"
          - "lib/os/webcam*"
          - "lib/os/**/webcam*"

      # Audio system
      audio_system:
        target: 50%
        threshold: 2%
        paths:
          - "lib/audio.*"
          - "lib/mixer.*"
          - "lib/ringbuffer.*"

      # Network infrastructure
      network_infrastructure:
        target: 50%
        threshold: 2%
        paths:
          - "lib/network/**/*"
          - "lib/packet_queue.*"
          - "lib/buffer_pool.*"

      # Security components (crypto is now a directory)
      security_crypto:
        target: 50%
        threshold: 2%
        paths:
          - "lib/crypto/**/*"
          - "lib/crc32.*"

      # Terminal rendering and output
      terminal_rendering:
        target: 50%
        threshold: 2%
        paths:
          - "lib/image2ascii/ansi_fast.*"
          - "lib/platform/**/terminal.*"
          - "lib/platform/terminal.h"
          - "lib/palette.*"

      # Video frame handling
      video_frames:
        target: 50%
        threshold: 2%
        paths:
          - "lib/video_frame.*"

      # Core utilities and error handling
      core_utilities:
        target: 50%
        threshold: 2%
        paths:
          - "lib/asciichat_errno.*"
          - "lib/common.*"
          - "lib/compression.*"
          - "lib/util/**/*"

      # Debug utilities
      debug_utilities:
        target: 40%
        threshold: 5%
        paths:
          - "lib/debug/**/*"
        informational: true

      # Tooling (defer, panic, query)
      tooling:
        target: 40%
        threshold: 5%
        paths:
          - "lib/tooling/**/*"
          - "src/tooling/**/*"
        informational: true

      # Main entry point
      main_entry:
        target: 50%
        threshold: 2%
        paths:
          - "src/main.c"

      # Test infrastructure
      test_framework:
        target: 60%
        threshold: 3%
        paths:
          - "tests/**/*"
        informational: true  # Don't fail builds on test framework coverage

    # Patch-level status checks (for PRs)
    patch:
      # Overall patch coverage
      default:
        target: 60%
        threshold: 0%  # Strict - all new code should be tested
        base: auto
        branches:
          - master
          - main
          - palettes
        if_ci_failed: error
        only_pulls: true
        informational: false

      # Stricter patch requirements for core functionality
      core_patch:
        target: 60%
        threshold: 5%
        base: auto
        paths:
          - "src/server/**/*"
          - "src/client/**/*"
          - "lib/image2ascii/**/*"
          - "lib/network/**/*"
          - "lib/crypto/**/*"
        branches:
          - master
          - main
          - palettes
        if_ci_failed: error
        only_pulls: true

      # Security code patch coverage
      security_patch:
        target: 70%
        threshold: 5%
        base: auto
        paths:
          - "lib/crypto/**/*"
          - "lib/crc32.*"
        branches:
          - master
          - main
          - palettes
        if_ci_failed: error
        only_pulls: true

      # SIMD optimizations patch coverage
      simd_patch:
        target: 50%
        threshold: 10%
        base: auto
        paths:
          - "lib/image2ascii/simd/**/*"
        branches:
          - master
          - main
          - palettes
        if_ci_failed: error
        only_pulls: true

      # Test files should be covered too
      tests_patch:
        target: 80%
        threshold: 10%
        base: auto
        paths:
          - "tests/**/*"
        branches:
          - master
          - main
          - palettes
        if_ci_failed: success  # Don't fail CI for test coverage
        only_pulls: true
        informational: true

    # Changes status - detects unexpected coverage changes
    changes:
      default:
        # Detect coverage changes not in the diff
        if_ci_failed: error
        branches:
          - master
          - main
          - palettes

# Component management for detailed reporting
component_management:
  # Default rules inherited by all components
  default_rules:
    # Default paths that apply to all components unless overridden
    paths:
      - "lib/**/*"
      - "src/**/*"
    # Flag regexes to include specific flag patterns
    flag_regexes:
      - "ascii-chat-tests.*"
      - "coverage"
    statuses:
      - type: project
        target: auto
        threshold: 2%
        branches:
          - "!master"  # Don't run on master to reduce noise
      - type: patch
        target: 70%
        threshold: 5%

  # Individual components for detailed tracking
  individual_components:
    # Server core functionality
    - component_id: server_core
      name: "Server Core"
      paths:
        - "src/server/**/*"
        - "tests/**/server*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 60%

    # Client core functionality
    - component_id: client_core
      name: "Client Core"
      paths:
        - "src/client/**/*"
        - "tests/**/client*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 60%

    # ASCII art conversion engine
    - component_id: ascii_engine
      name: "ASCII Art Engine"
      paths:
        - "lib/image2ascii/**/*"
        - "tests/**/ascii*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 60%

    # SIMD optimizations
    - component_id: simd_optimizations
      name: "SIMD Optimizations"
      paths:
        - "lib/image2ascii/simd/**/*"
        - "tests/**/simd*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 5%
        - type: patch
          target: 50%

    # Network protocol and communication
    - component_id: networking
      name: "Network Protocol"
      paths:
        - "lib/network/**/*"
        - "lib/packet_queue.*"
        - "tests/**/network*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 60%

    # Audio processing and mixing
    - component_id: audio_processing
      name: "Audio Processing"
      paths:
        - "lib/audio.*"
        - "lib/mixer.*"
        - "lib/ringbuffer.*"
        - "tests/**/audio*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 50%

    # Video capture and processing
    - component_id: video_processing
      name: "Video Processing"
      paths:
        - "lib/image2ascii/image.*"
        - "lib/os/webcam*"
        - "lib/os/**/webcam*"
      statuses:
        - type: project
          target: 50%
          threshold: 5%

    # Security and cryptography
    - component_id: security
      name: "Security & Crypto"
      paths:
        - "lib/crypto/**/*"
        - "lib/crc32.*"
        - "tests/**/crypto*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 60%

    # Memory management and data structures
    - component_id: data_structures
      name: "Data Structures"
      paths:
        - "lib/buffer_pool.*"
        - "lib/packet_queue.*"
        - "lib/ringbuffer.*"
        - "tests/**/buffer_pool*.c"
        - "tests/**/packet_queue*.c"
        - "tests/**/ringbuffer*.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%
        - type: patch
          target: 60%

    # Terminal output and rendering
    - component_id: terminal_output
      name: "Terminal Output"
      paths:
        - "lib/image2ascii/ansi_fast.*"
        - "lib/platform/**/terminal.*"
        - "lib/palette.*"
      statuses:
        - type: project
          target: 50%
          threshold: 5%

    # Configuration and options
    - component_id: configuration
      name: "Configuration"
      paths:
        - "lib/options.*"
        - "lib/logging.*"
        - "lib/config.*"
      statuses:
        - type: project
          target: 50%
          informational: true

    # Video frame handling
    - component_id: video_frames
      name: "Video Frames"
      paths:
        - "lib/video_frame.*"
      statuses:
        - type: project
          target: 50%
          threshold: 2%

    # Core utilities
    - component_id: core_utilities
      name: "Core Utilities"
      paths:
        - "lib/asciichat_errno.*"
        - "lib/common.*"
        - "lib/compression.*"
        - "lib/util/**/*"
      statuses:
        - type: project
          target: 50%
          threshold: 2%

    # Debug utilities
    - component_id: debug_utilities
      name: "Debug Utilities"
      paths:
        - "lib/debug/**/*"
      statuses:
        - type: project
          target: 40%
          informational: true

    # Tooling
    - component_id: tooling
      name: "Tooling"
      paths:
        - "lib/tooling/**/*"
        - "src/tooling/**/*"
      statuses:
        - type: project
          target: 40%
          informational: true

    # Main entry point
    - component_id: main_entry
      name: "Main Entry"
      paths:
        - "src/main.c"
      statuses:
        - type: project
          target: 50%
          threshold: 2%

    # Platform abstraction layer
    - component_id: platform_abstraction
      name: "Platform Abstraction"
      paths:
        - "lib/platform/**/*"
      statuses:
        - type: project
          target: 50%
          threshold: 5%
        - type: patch
          target: 50%

    # Integration tests
    - component_id: integration_tests
      name: "Integration Tests"
      paths:
        - "tests/integration/**/*"
      statuses:
        - type: project
          target: 60%
          informational: true

    # Cross-cutting components (span multiple directories)
    - component_id: simd_all
      name: "All SIMD Code"
      paths:
        - "lib/image2ascii/simd/**/*"
      flag_regexes:
        - "ascii-chat-tests.*"
      statuses:
        - type: project
          target: 50%
          threshold: 5%
        - type: patch
          target: 50%

    - component_id: test_infrastructure
      name: "Test Infrastructure"
      paths:
        - "tests/**/*.c"
        - "tests/**/*.h"
        - "lib/tests/**/*"
      flag_regexes:
        - "coverage"
        - "ascii-chat-tests.*"
      statuses:
        - type: project
          target: 50%
          informational: true

    - component_id: headers
      name: "Header Files"
      paths:
        - "lib/**/*.h"
        - "src/**/*.h"
      statuses:
        - type: project
          target: auto
          informational: true

    - component_id: platform_specific
      name: "Platform-Specific Code"
      paths:
        - "lib/os/**/webcam*"
        - "lib/platform/posix/**/*"
        - "lib/platform/windows/**/*"
        - "lib/image2ascii/simd/neon.*"
        - "lib/image2ascii/simd/sse*.*"
        - "lib/image2ascii/simd/avx*.*"
        - "lib/image2ascii/simd/sve.*"
      statuses:
        - type: project
          target: 40%
          threshold: 10%
          informational: true

# Pull request comment configuration
comment:
  layout: "header, diff, flags, components, footer"
  behavior: default
  require_changes: false
  require_base: false
  require_head: true
  branches:
    - master
    - main
    - palettes
  # Show component information prominently in PR comments
  show_carryforward_flags: false

# Ignore certain paths from coverage calculation
ignore:
  - "build/**/*"
  - "bin/**/*"
  - "*.gcov"
  - "**/*.gcov"
  - ".github/**/*"
  - "notes/**/*"
  - "todo/**/*"
  - "README.md"
  - "Makefile*"
  - "Info.plist"
  - "**/.DS_Store"
  - "**/compile_commands.json"
  - "lib/version.c"
  - "lib/version.h.in"
  - "lib/musl_c23_compat.c"

# Flag configuration for organizing uploads
flags:
  ascii-chat-tests-ubuntu-debug:
    paths:
      - "lib/"
      - "src/"
      - "tests/"
    carryforward: false
  ascii-chat-tests-ubuntu-release:
    paths:
      - "lib/"
      - "src/"
      - "tests/"
    carryforward: false
  ascii-chat-tests-macos-debug:
    paths:
      - "lib/"
      - "src/"
      - "tests/"
    carryforward: false
  ascii-chat-tests-macos-release:
    paths:
      - "lib/"
      - "src/"
      - "tests/"
    carryforward: false
  ascii-chat-tests:
    paths:
      - "lib/"
      - "src/"
      - "tests/"
    carryforward: false
  coverage:
    paths:
      - "lib/"
      - "src/"
      - "tests/"
    carryforward: false
  ascii-chat-integration-ubuntu:
    paths:
      - "lib/"
      - "src/"
      - "tests/integration/"
    carryforward: false
  ascii-chat-integration-macos:
    paths:
      - "lib/"
      - "src/"
      - "tests/integration/"
    carryforward: false
  ascii-chat-performance-ubuntu:
    paths:
      - "lib/"
      - "src/"
      - "tests/performance/"
    carryforward: false
  ascii-chat-performance-macos:
    paths:
      - "lib/"
      - "src/"
      - "tests/performance/"
    carryforward: false

# Notification settings
github_checks:
  annotations: true

# Profiling configuration for YAML reporting
profiling:
  # Enable YAML report customization
  critical_files_paths:
    - "src/server/**/*"
    - "src/client/**/*"
    - "lib/image2ascii/**/*"
    - "lib/network/**/*"
    - "lib/crypto/**/*"
