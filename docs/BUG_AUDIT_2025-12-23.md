# ASCII-Chat Codebase Bug Audit Report
**Date:** 2025-12-23
**Auditor:** Claude (Automated Static Analysis)

## Executive Summary

A comprehensive audit of the ascii-chat codebase identified **29 bugs** across 8 categories:
- **13 Critical** bugs requiring immediate fixes (security/stability)
- **8 High Priority** bugs (crashes, leaks, security)
- **8 Medium Priority** bugs (code quality, consistency)

The codebase demonstrates generally good practices with SAFE_MALLOC macros, platform abstraction, and error handling. However, several areas need attention, particularly around thread synchronization, bounds checking in network code, and consistent use of platform abstractions.

---

## Critical Bugs

### 1. Buffer Overflow in Opus Audio Decoding
**File:** `src/server/protocol.c:1095-1107`
**Severity:** CRITICAL - Remote Code Execution
**Description:** No bounds check before writing decoded audio samples. Malicious Opus frames could decode to more samples than the allocated buffer.

```c
// VULNERABLE CODE
int decoded_count = opus_codec_decode(..., &decoded_samples[total_decoded], samples_per_frame);
total_decoded += decoded_count;  // No check that this fits in buffer!
```

**Fix:**
```c
if (total_decoded + samples_per_frame > total_samples) {
  log_error("Opus decode would overflow buffer");
  return;
}
int decoded_count = opus_codec_decode(...);
```

---

### 2. Buffer Overflow in SSH Agent Key Addition
**File:** `lib/crypto/ssh_agent.c:247-254`
**Severity:** CRITICAL - Local Privilege Escalation
**Description:** Key path copied to 4096-byte stack buffer without length validation.

```c
// VULNERABLE CODE
len = key_path ? strlen(key_path) : 0;  // No length limit!
memcpy(buf + pos, key_path, len);       // Can overflow!
```

**Fix:**
```c
len = key_path ? strlen(key_path) : 0;
if (len > sizeof(buf) - pos - 4) {
  return SET_ERRNO(ERROR_BUFFER_OVERFLOW, "SSH key path too long");
}
```

---

### 3. Thread Safety: Mixer Process Without Lock
**File:** `lib/audio/mixer.c:434-438, 558-563`
**Severity:** CRITICAL - Race Condition / Crash
**Description:** `mixer_process()` reads `source_buffers`, `source_ids`, and `source_active` arrays without holding the source lock, while `mixer_add_source()` and `mixer_remove_source()` modify them under write lock.

```c
// VULNERABLE CODE in mixer_process()
for (int i = 0; i < mixer->max_sources; i++) {
  if (mixer->source_ids[i] != 0 && mixer->source_active[i] && mixer->source_buffers[i]) {
    // Race: Another thread could set source_buffers[i] = NULL here!
    active_count++;
  }
}
```

**Fix:** Add `rwlock_rdlock(&mixer->source_lock)` at the start of `mixer_process()`.

---

### 4. TOCTOU Race in UTF-8 Cache Lock Upgrade
**File:** `lib/image2ascii/simd/common.c:327-336`
**Severity:** CRITICAL - Use-After-Free
**Description:** Cache entry looked up under read lock, then read lock released and write lock acquired. Another thread can evict the cache entry in between, causing use-after-free.

```c
// VULNERABLE CODE
rwlock_rdlock(&g_utf8_cache_rwlock);
HASH_FIND_INT(g_utf8_cache_table, &palette_hash, cache);
if (cache && new_access_count % 10 == 0) {
  rwlock_rdunlock(&g_utf8_cache_rwlock);  // Release read lock
  rwlock_wrlock(&g_utf8_cache_rwlock);    // Acquire write lock
  // VULNERABLE WINDOW: cache pointer may now be invalid!
  utf8_heap_update_score(cache, new_score);  // Use-after-free!
}
```

**Fix:** Re-lookup cache entry after acquiring write lock:
```c
rwlock_wrunlock(&g_utf8_cache_rwlock);
rwlock_wrlock(&g_utf8_cache_rwlock);
HASH_FIND_INT(g_utf8_cache_table, &palette_hash, cache);  // Re-find!
if (cache) {
  utf8_heap_update_score(cache, new_score);
}
```

---

### 5. Unprotected Read of client_count
**File:** `src/server/main.c:818-820, 843, 1060`
**Severity:** CRITICAL - Race Condition
**Description:** `g_client_manager.client_count` read without holding rwlock while other threads modify it under write lock.

**Fix:** Wrap reads with `rwlock_rdlock()` or make `client_count` atomic.

---

### 6. Client Count Read After Lock Release
**File:** `src/server/client.c:627`
**Severity:** CRITICAL - Race Condition
**Description:** Write lock released at line 517, but `client_count` read at line 627 without any lock.

**Fix:** Either keep write lock until after the read, or acquire read lock before accessing.

---

### 7. Unchecked Allocations in buffer_pool_create_single
**File:** `lib/buffer_pool.c:27-57`
**Severity:** CRITICAL - NULL Dereference / Memory Leak
**Description:** Three allocations without NULL checks. If second or third allocation fails, previous allocations are leaked and NULL is dereferenced.

```c
// VULNERABLE CODE
pool = SAFE_MALLOC(sizeof(buffer_pool_t), buffer_pool_t *);  // No check!
pool->nodes = SAFE_MALLOC(...);    // No check! Leaks pool if fails
pool->memory_block = SAFE_MALLOC_ALIGNED(...);  // No check!
uint8_t *current_buffer = (uint8_t *)pool->memory_block;  // NULL deref!
```

**Fix:** Check each allocation and cleanup on failure.

---

### 8. Unchecked Sub-Pool Creation
**File:** `lib/buffer_pool.c:146-154`
**Severity:** CRITICAL - NULL Dereference
**Description:** `data_buffer_pool_create()` creates 4 sub-pools without checking if any return NULL.

**Fix:** Check each `buffer_pool_create_single()` return and cleanup on failure.

---

### 9. Ducking Init Allocation Failure
**File:** `lib/audio/mixer.c:152-165`
**Severity:** CRITICAL - NULL Dereference
**Description:** `ducking_init()` can fail allocations but has no way to signal failure to caller. Later code dereferences NULL.

**Fix:** Make `ducking_init()` return `asciichat_error_t` and check in `mixer_create()`.

---

### 10. Image Pixel Allocation Not Checked
**File:** `lib/image2ascii/image.c:73`
**Severity:** CRITICAL - NULL Dereference
**Description:** `SAFE_MALLOC_SIMD` for pixels not checked, function returns image with NULL pixels.

**Fix:**
```c
p->pixels = SAFE_MALLOC_SIMD(pixels_size, rgb_t *);
if (!p->pixels) {
  SAFE_FREE(p);
  return NULL;
}
```

---

### 11. Trust Anchors Memory Leak
**File:** `lib/crypto/http_client.c:130-132`
**Severity:** CRITICAL - Memory Leak
**Description:** Early return when `num_anchors == 0` doesn't free allocated `anchors.buf`.

**Fix:** Free anchors before returning:
```c
if (num_anchors == 0) {
  for (size_t i = 0; i < anchors.ptr; i++) {
    free_ta_contents(&anchors.buf[i]);
  }
  SAFE_FREE(anchors.buf);
  return NULL;
}
```

---

### 12. Integer Overflow in Pixel Count
**File:** `lib/image2ascii/simd/ascii_simd.c:337, 498, 652, 852`
**Severity:** CRITICAL - Buffer Overflow
**Description:** `int pixel_count = width * height` can overflow before allocation.

**Fix:** `size_t pixel_count = (size_t)width * (size_t)height;`

---

### 13. Incomplete Type Casting
**File:** `lib/network/av.c:116`
**Severity:** CRITICAL - Integer Overflow
**Description:** Only width is cast: `(size_t)width * height * 3`

**Fix:** `(size_t)width * (size_t)height * 3`

---

## High Priority Bugs

### 14. SSH Agent Response Over-Read
**File:** `lib/crypto/ssh_agent.c:140-174`
**Severity:** HIGH - Information Disclosure
**Description:** Parsing SSH agent response with insufficient bounds validation.

---

### 15. Unchecked Key Allocation
**File:** `lib/crypto/keys/https_keys.c:330-342`
**Severity:** HIGH - NULL Dereference
**Description:** `parse_ssh_keys_from_response()` doesn't check allocations.

---

### 16. GPG Key Allocation Leak
**File:** `lib/crypto/keys/https_keys.c:390-391`
**Severity:** HIGH - Memory Leak
**Description:** First allocation leaked if second fails.

---

### 17. Array Index Overflow
**File:** `lib/image2ascii/simd/ascii_simd.c:678-679, 896-897`
**Severity:** HIGH - Out-of-Bounds Access
**Description:** `src_y * source_image->w + src_x` can overflow.

---

### 18. Dithering Buffer Index Overflow
**File:** `lib/image2ascii/ansi_fast.c:353`
**Severity:** HIGH - Out-of-Bounds Write
**Description:** `y * width + x` calculated without overflow check.

---

### 19. Cell Area Overflow
**File:** `src/server/stream.c:591, 627`
**Severity:** HIGH - Integer Overflow
**Description:** `cell_width * cell_height` can overflow int.

---

### 20. Unix Domain Sockets Without Abstraction
**File:** `lib/crypto/gpg.c:276-342`
**Severity:** HIGH - Windows Incompatibility
**Description:** Direct AF_UNIX usage, `close()` instead of `socket_close()`.

---

### 21. Socket Init to Zero
**File:** `src/server/main.c:909`
**Severity:** HIGH - Windows Bug
**Description:** `socket_t max_fd = 0` - 0 is a valid socket on Windows.

**Fix:** `socket_t max_fd = INVALID_SOCKET_VALUE;`

---

## Medium Priority Bugs

### 22. Mutex Init Unchecked
**File:** `lib/buffer_pool.c:154`
**Severity:** MEDIUM
**Description:** `mutex_init()` return value ignored.

---

### 23. Missing NULL Parameter Validation
**File:** `lib/audio/mixer.c:70-93`
**Severity:** MEDIUM
**Description:** `compressor_init()`, `compressor_set_params()`, `ducking_init()` don't validate parameters.

---

### 24. Grid Calculation Overflow
**File:** `lib/image2ascii/ascii.c:499, 533`
**Severity:** MEDIUM
**Description:** Position calculations can overflow.

---

### 25. Dimension Truncation
**File:** `lib/image2ascii/image.c:118-119`
**Severity:** MEDIUM
**Description:** `size_t` width/height truncated to `int` in struct.

---

### 26-29. Platform Abstraction Inconsistencies
**Files:** Various
**Severity:** MEDIUM
**Description:** Direct socket/send/recv calls instead of platform abstractions.

---

## Recommendations

### Immediate Actions
1. Fix all CRITICAL buffer overflow bugs (security vulnerabilities)
2. Add thread synchronization to mixer audio processing
3. Add NULL checks after all allocations in buffer_pool.c

### Short-Term
4. Audit all network packet parsing for bounds checking
5. Replace all `int` dimension multiplications with `size_t` casts
6. Add parameter validation to public API functions

### Long-Term
7. Enable AddressSanitizer in CI/CD pipeline
8. Add static analysis (clang-analyzer) to build
9. Implement fuzzing for network packet handling
10. Ensure consistent use of platform abstraction layer

---

## Files Requiring Changes

| Priority | File | Bug Count |
|----------|------|-----------|
| CRITICAL | `lib/buffer_pool.c` | 3 |
| CRITICAL | `lib/audio/mixer.c` | 3 |
| CRITICAL | `src/server/protocol.c` | 1 |
| CRITICAL | `lib/crypto/ssh_agent.c` | 2 |
| CRITICAL | `lib/image2ascii/simd/common.c` | 1 |
| CRITICAL | `src/server/main.c` | 2 |
| CRITICAL | `src/server/client.c` | 1 |
| HIGH | `lib/image2ascii/simd/ascii_simd.c` | 3 |
| HIGH | `lib/crypto/keys/https_keys.c` | 2 |
| HIGH | `lib/crypto/gpg.c` | 1 |
| MEDIUM | Various platform files | 4 |
